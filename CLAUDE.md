# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**La Pluma, el Faro y la Llama** — a static website for three Spanish-language authors (Lauren Cuervo, A.C. Elysia, Draco Sahir). Combines blog, portfolio, book publishing, and an AI agent console ("Velvet Console"). The project is primarily in Spanish.

- **Live site:** https://plumafarollama.com
- **Hosting:** Firebase Hosting (primary), GitHub Pages (secondary via CI)
- **Firebase project:** `lapluma-elfaro-lallama`

## Commands

```bash
npm install                        # Install Node dependencies
npm test                           # HTMLHint + SEO metadata validation
npm run build                      # Responsive images + test
npm run seo                        # Generate portfolio pages + blog pages + sitemap
npm run blog:generate              # Full blog static page generation
npm run blog:generate:inc          # Incremental (only changed pages)
npm run portfolio:generate         # Generate SEO pages for portfolio items
npm run responsive                 # Generate responsive image variants (sharp)
npm run version                    # Hash-version CSS/JS for cache busting
npm run publish:chapters           # Render book chapters from markdown to HTML
npm run rotate-featured            # Manage featured posts list
firebase serve                     # Local dev server at http://localhost:5000
firebase deploy                    # Deploy to Firebase Hosting
```

## Architecture

### No Bundler — Script-based Build

There is no webpack/vite/rollup. The project uses standalone Node.js scripts for generation and optimization. CSS and JS files are served directly, with hash-based versioning for cache busting (`version-assets.js` renames files like `styles.css` → `styles.{hash}.css` and updates all references).

### Static Generation Pipeline

Content lives in JSON data files; Node.js scripts generate static HTML pages:

- **Blog:** `posts.json` → `tools/generate-blog-pages.js` → `blog/*.html`
- **Portfolio:** `portfolio.html` modals → `tools/generate-portfolio-pages.js` → `portfolio/*.html`
- **Books:** `assets/books/*/chapters/*.md` + `chapters_manifest.json` → `scripts/publish_chapters.js` → `books/*/*.html`
- **Sitemap:** `js/generate-sitemap.js` → `sitemap.xml`

Templates live in `templates/` (e.g., `blog-entry-template.html`, `book-chapter-template.html`).

### Frontend

Plain HTML/CSS/JS — no framework. Key modules in `js/`:
- `main.{hash}.js` — App bootstrap, Service Worker registration, preloader
- `firebase-init.js` — Firebase SDK loader and Firestore config (compat v10.5.2)
- `blog.js` / `blog-entry.js` — Blog listing and individual post display
- `portfolio.js` — Portfolio modal management with responsive image loading
- `book-navigation.js` — Book chapter navigation
- `contact.js` — Contact form with reCAPTCHA v3

CSS is consolidated into `css/styles.{hash}.css` with `css/custom-overrides.css` for additions.

### Backend (PHP API)

PHP endpoints in `api/` handle server-side operations:
- `submit.php` — Contact form (reCAPTCHA + rate limiting + Firestore + email via PHPMailer)
- `newsletter.php` — Newsletter subscriptions
- `reactions.php` / `react.php` — Post reactions (Firestore)
- `velvet.php` — AI agent console responses
- `post.php` / `fortune_cookie.php` — GET endpoints for individual items

Config loaded from `.env` via `vlucas/phpdotenv`. PHP autoloading: `PSR-4` under `src/`.

### Data Files

- `posts.json` — Blog posts database (the source of truth for blog content)
- `fortune_cookies.json` — Fortune cookie data
- `featured.json` — Optional override for featured posts (generated by `rotate-featured`)
- `assets/books/*/metadata.json` + `chapters_manifest.json` — Book configuration

### Service Worker

`sw.js` uses a network-first strategy with offline fallback. Cache name is versioned (`site-cache-v{N}`). When updating cached assets, increment the cache version number.

## Key Conventions

- **Asset versioning:** After changing CSS/JS, run `npm run version` to regenerate hash filenames and update references across HTML and `sw.js`
- **Generated directories:** `blog/`, `portfolio/`, `books/` contain generated HTML — don't manually edit files there
- **Responsive images:** Generated at 400/800/1200px widths in WebP. `assets/images/social/` is excluded from responsive generation (preserves 9:16 ratio for social media)
- **Image naming:** Vertical social variants use `-ig.png` suffix and go in `assets/images/social/blog/` or `assets/images/social/fortune_cookies/`
- **Branch convention:** Feature branches use `codex/feature-description` pattern
- **Blog posts:** Future-dated posts in `posts.json` are automatically filtered out by the frontend; use `posts-pendientes.json` for editorial scheduling
- **SEO validation:** `npm test` checks all HTML pages for required meta tags (title, description, OG, Twitter cards, JSON-LD). Missing metadata fails the build.

## CI/CD Workflows (`.github/workflows/`)

- `deploy.yml` — Push to `main` → generate SEO pages → test → deploy to GitHub Pages
- `generate-blog.yml` — Push to `posts.json` → incremental blog generation → auto-commit
- `publish-chapters.yml` — Weekly cron (Friday 00:00 UTC) → publish scheduled book chapters → auto-commit
- `responsive-images.yml` — Generate responsive image variants
