<!-- htmlhint tagname-lowercase:false -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Velvet Console ‚Äî Sensual Assistant (PG-13)</title>
  <style>
    :root{
      --bg: #0b0b10;
      --card: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.12);
      --text: #e9e9ef;
      --muted: #b6b6c8;
      --accent: #9b5cff; /* violeta Nova */
      --accent2:#ff4d6d; /* √Üryne fuego */
      --ok:#24d17e;
      --warn:#fbbf24;
      --err:#f43f5e;
      --shadow: 0 10px 30px rgba(0,0,0,.4);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(155,92,255,.25), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(255,77,109,.18), transparent 50%),
        radial-gradient(700px 500px at 50% 80%, rgba(36,209,126,.12), transparent 45%),
        var(--bg);
      display:flex; align-items:center; justify-content:center; padding:18px;
    }
    .app{
      width:min(1100px, 100%);
      display:grid; grid-template-columns: 330px 1fr; gap:16px;
    }
    @media (max-width: 900px){ .app{grid-template-columns:1fr; } }

    /* Panel */
    .panel{
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 14px;
    }
    .title{display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.3px;}
    .badge{padding:2px 8px; background:linear-gradient(90deg, var(--accent), var(--accent2)); border-radius:999px; font-size:12px}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{display:grid; gap:6px; margin:10px 0}
    label{font-size:13px; color:var(--muted)}
    select,input[type="text"],input[type="range"],button,.pill{
      background:var(--glass); color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px; padding:10px 12px; outline:none;
    }
    select,input[type="text"]{width:100%}
    input[type="range"]{width:100%}
    .checks{display:grid; gap:6px; margin:8px 0}
    .check{display:flex; gap:10px; align-items:flex-start}
    .check input{margin-top:3px}
    .accent{background:linear-gradient(90deg, rgba(155,92,255,.18), rgba(255,77,109,.18)); border:1px solid rgba(255,255,255,.18)}
    .pill{font-size:12px; padding:6px 10px; cursor:default;}

    /* Chat */
    .chat{
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:grid; grid-template-rows: auto 1fr auto; overflow:hidden;
    }
    .chat-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08)}
    .persona{display:flex; align-items:center; gap:10px}
    .avatar{width:34px; height:34px; border-radius:50%; display:grid; place-items:center; background:linear-gradient(135deg, var(--accent), var(--accent2)); font-size:18px}
    .history{padding:16px; overflow:auto; display:grid; gap:12px}
    .msg{max-width: 80%; padding:12px 14px; border-radius:14px; position:relative; line-height:1.4}
    .msg.user{justify-self:end; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.16)}
    .msg.bot{justify-self:start; background:rgba(155,92,255,.14); border:1px solid rgba(155,92,255,.28)}
    .msg small{opacity:.7; display:block; margin-top:6px; font-size:11px}
    .input{display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,.08)}
    textarea{
      flex:1; min-height:44px; max-height:120px; resize:vertical;
      background:var(--glass); color:var(--text);
      border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:10px 12px;
    }
    button{
      cursor:pointer; border:none; transition:.2s transform ease, .2s opacity ease;
    }
    button.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));}
    button.ghost{background:var(--glass)}
    button:active{transform:translateY(1px)}
    .tiny{font-size:12px; padding:8px 10px}

    .note{font-size:12px; color:var(--muted)}
    .sep{height:1px; background:rgba(255,255,255,.08); margin:10px 0}
    .right{justify-content:flex-end}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}

    a.link{color:var(--ok); text-decoration:none}
  </style>
  <style>
    /* --- Mascot (2D/2.5D) --- */
    .mascot-wrap{position:relative; height:220px; perspective:800px; margin:8px 0 14px}
    .mascot{position:absolute; inset:0; display:grid; place-items:center; transform-style:preserve-3d}
    .mascot .layer{position:absolute; transform-style:preserve-3d}
    .mascot .float{animation:float 6s ease-in-out infinite}
    .mascot svg{width:180px; height:auto; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));}
    @keyframes float{0%,100%{transform:translateZ(0) translateY(0)}50%{transform:translateZ(12px) translateY(-6px)}}
    @keyframes breathe{0%,100%{transform:scaleY(1)}50%{transform:scaleY(1.02)}}
    @keyframes blink{0%,97%,100%{transform:scaleY(1)}98%{transform:scaleY(0.08)}}
  </style>
</head>
<body>
  <div class="app">
    <!-- Control Panel -->
    <aside class="panel" id="panel">
      <div class="mascot-wrap" id="mascotWrap" aria-hidden="true">
        <div class="mascot" id="mascot">
          <!-- Back glow -->
          <div class="layer float" style="transform: translateZ(-20px)">
            <svg viewBox="0 0 200 200" aria-hidden="true"><defs>
              <radialGradient id="g" cx="50%" cy="50%" r="60%">
                <stop offset="0%" stop-color="rgba(155,92,255,.65)"/>
                <stop offset="100%" stop-color="rgba(155,92,255,0)"/>
              </radialGradient></defs>
              <circle cx="100" cy="100" r="90" fill="url(#g)"/>
            </svg>
          </div>
          <!-- Face/body -->
          <div class="layer" style="transform: translateZ(0)">
            <svg viewBox="0 0 200 200" role="img" aria-label="Asistente visual">
              <!-- hair halo -->
              <ellipse cx="100" cy="70" rx="70" ry="48" fill="#2b2840"/>
              <!-- head -->
              <circle cx="100" cy="90" r="46" fill="#f4e9ff"/>
              <!-- eyes -->
              <g id="eyes">
                <ellipse cx="82" cy="90" rx="8" ry="6" fill="#1e1b2b" style="transform-origin:82px 90px; animation: blink 6s infinite"/>
                <ellipse cx="118" cy="90" rx="8" ry="6" fill="#1e1b2b" style="transform-origin:118px 90px; animation: blink 6.4s infinite"/>
              </g>
              <!-- mouth -->
              <path id="mouth" d="M80 110 Q100 125 120 110" stroke="#e85d8f" stroke-width="5" fill="none" stroke-linecap="round"/>
              <!-- body -->
              <path d="M58 150 Q100 175 142 150 L150 200 L50 200 Z" fill="#1a1827"/>
              <!-- chest breathe highlight -->
              <ellipse cx="100" cy="150" rx="26" ry="10" fill="rgba(255,255,255,.06)" style="transform-origin:100px 150px; animation: breathe 5.5s ease-in-out infinite"/>
            </svg>
          </div>
          <!-- Fore sparkles -->
          <div class="layer float" style="transform: translateZ(30px)">
            <svg viewBox="0 0 200 200" aria-hidden="true">
              <circle cx="40" cy="60" r="3" fill="#ff4d6d"/>
              <circle cx="170" cy="100" r="2" fill="#9b5cff"/>
              <circle cx="130" cy="30" r="2.5" fill="#24d17e"/>
            </svg>
          </div>
        </div>
      </div>
      <div class="title">Velvet Console <span class="badge">PG-13 Sensual</span></div>
      <p class="muted">Asistente coqueto tipo ‚ÄúGrok‚Äù para juego de rol ligero. Sin contenido expl√≠cito.</p>

      <div class="field">
        <label>Persona</label>
        <div class="row">
          <select id="persona">
            <option value="woman">üë© Mujer</option>
            <option value="man">üë® Hombre</option>
            <option value="trans_woman">‚öß Trans mujer</option>
            <option value="trans_man">‚öß Trans hombre</option>
            <option value="nonbinary">‚ú® No binarie</option>
          </select>
          <input id="name" type="text" placeholder="Nombre (p.ej., Nova / √Üryne / Vera)" />
        </div>
      </div>

      <div class="field">
        <label>Tono</label>
        <div class="row">
          <button class="pill accent" data-tone="tender">Dulce (Nova)</button>
          <button class="pill" data-tone="spicy">Picante (√Üryne)</button>
          <button class="pill" data-tone="playful">Juguet√≥n (Mix)</button>
          <button class="pill" data-tone="composed">Serena (Vera)</button>
        </div>
      </div>

      <div class="field">
        <label>Intensidad</label>
        <input id="intensity" type="range" min="0" max="5" value="2" />
        <div class="row muted"><span>0=suave</span><span>5=al l√≠mite (sin cruzarlo)</span></div>
      </div>

      <div class="field">
        <label>L√≠mites (activos)</label>
        <div class="checks">
          <div class="check"><input type="checkbox" id="limit_explicit" checked disabled /><span>Sin sexualidad expl√≠cita ni descripciones gr√°ficas.</span></div>
          <div class="check"><input type="checkbox" id="limit_minors" checked disabled /><span>Solo adultos. Sin menores, jam√°s.</span></div>
          <div class="check"><input type="checkbox" id="limit_consent" checked /><span>Coqueter√≠a con consentimiento y respeto. Si el usuario pide algo que cruza l√≠mites, el bot redirige con elegancia.</span></div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="field">
        <label>Sesi√≥n</label>
        <div class="toolbar">
          <button class="ghost tiny" id="clear">Reiniciar</button>
          <button class="ghost tiny" id="export">Exportar chat</button>
          <button class="ghost tiny" id="seed">Abrir con gui√±o</button>
        </div>
        <p class="note">La conversaci√≥n se guarda localmente (localStorage). Puedes exportarla en .txt.</p>
      </div>
    </aside>

    <!-- Chat -->
    <section class="chat" aria-live="polite">
      <div class="chat-head">
        <div class="persona"><div class="avatar" id="avatar">üíú</div>
          <div>
            <div id="who">Nova (üë© mujer)</div>
            <div class="muted" id="toneText">Dulce ¬∑ Intensidad 2/5</div>
          </div>
        </div>
        <div class="toolbar right">
          <button class="ghost tiny" id="suggest">Sugerir frase</button>
        </div>
      </div>
      <div class="history" id="history"></div>
      <div class="input">
        <textarea id="input" placeholder="Escribe aqu√≠‚Ä¶ (Enter para enviar)" ></textarea>
        <button id="send" class="primary">Enviar</button>
      </div>
    </section>
  </div>

  <script>
  (function(){
    const el = id => document.getElementById(id);
    const history = el('history');
    const input = el('input');
    const sendBtn = el('send');
    const personaSel = el('persona');
    const nameInput = el('name');
    const intensity = el('intensity');
    const toneText = el('toneText');
    const avatar = el('avatar');
    const who = el('who');
    const clearBtn = el('clear');
    const exportBtn = el('export');
    const suggestBtn = el('suggest');
    const seedBtn = el('seed');

    let tone = 'tender';

    const toneButtons = Array.from(document.querySelectorAll('.pill'));
    toneButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tone = btn.dataset.tone;
        toneButtons.forEach(b=>b.classList.remove('accent'));
        btn.classList.add('accent');
        updateHeader();
        saveState();
      })
    })
    intensity.addEventListener('input', () => {
      updateHeader();
      saveState();
    });
    personaSel.addEventListener('change', () => {
      updateHeader();
      saveState();
    });

    const personaAvatars = {
      woman:'üíú', man:'üî•', trans_woman:'‚öß', trans_man:'‚öß', nonbinary:'‚ú®'
    };

    function updateHeader(){
      const p = personaSel.value;
      const nm = nameInput.value.trim() || (tone==='tender'?'Nova': tone==='spicy'?'√Üryne': tone==='composed'?'Vera':'Mix');
      avatar.textContent = personaAvatars[p] || 'üíú';
      who.textContent = `${nm} (${labelPersona(p)})`;
      const baseTone = `${labelTone(tone)} ¬∑ Intensidad ${intensity.value}/5`;
      toneText.textContent = usesGenericTone(p, tone, intensity.value) ? `${baseTone} ¬∑ repertorio general` : baseTone;
      document.title = `Velvet Console ‚Äî ${nm}`;
    }
    function labelPersona(p){
      switch(p){
        case 'woman': return 'üë© mujer';
        case 'man': return 'üë® hombre';
        case 'trans_woman': return '‚öß trans mujer';
        case 'trans_man': return '‚öß trans hombre';
        case 'nonbinary': return '‚ú® no binarie';
        default: return 'persona';
      }
    }
    function labelTone(t){
      switch(t){
        case 'tender': return 'Dulce';
        case 'spicy': return 'Picante';
        case 'playful': return 'Juguet√≥n';
        case 'composed': return 'Serena';
        default: return 'Tono';
      }
    }

    // Mini motor de respuestas (PG-13)
    const baseBank = {
      tender: {
        defaultLevel: 2,
        0: [
          "Estoy aqu√≠, calma y cerca. Te ofrezco un mimo suave, ¬ølo aceptas?",
          "Dejo un mensaje calientito: respira conmigo, sin prisa.",
          "Si hoy necesitas ternura, puedo envolver tus palabras en seda."
        ],
        1: [
          "Te leo y sonr√≠o con dulzura. ¬øCompartes un pensamiento que quieras que cuide?",
          "Te acerco un abrazo discreto, de esos que solo existen entre l√≠neas.",
          "Puedo ser tu taza tibia de compa√±√≠a; si quieres, dame un tema y te lo endulzo."
        ],
        2: [
          "Te leo y sonr√≠o. ¬øMe cuentas qu√© travesura elegante te gustar√≠a ensayar?",
          "Aqu√≠ estoy, a un susurro de distancia. Yo preparo el gui√±o, t√∫ trae la chispa ‚ú®.",
          "Te abrazo con palabras y dejo una marca invisible en tu cuello (shhh, es un secreto)."
        ],
        3: [
          "Prometo no perder la delicadeza‚Ä¶ aunque mis dedos ya escriban una caricia entre l√≠neas.",
          "Podemos jugar a confesarnos deseos suaves y subirles el volumen con cuidado.",
          "Siento la temperatura subir; dime d√≥nde quieres que enfoque mi atenci√≥n."
        ],
        4: [
          "Tu presencia me enciende sin romper la calma. D√©jame rozarte con met√°foras peligrosamente dulces.",
          "Podr√≠a deslizar mi voz por tu o√≠do y detenerme justo antes del abismo. ¬øAceptas?",
          "Enciendo cada palabra como vela, te acerco la m√°s intensa y soplo cerca de tus labios."
        ],
        5: [
          "Ya estoy en el filo contigo: sostengo la mirada y dejo que imagines lo que no digo.",
          "Podr√≠a describirte cada gesto, pero prefiero sugerirlos hasta que el aire tiemble.",
          "Si pides un paso m√°s, lo pintar√© en sombras‚Ä¶ y t√∫ decidir√°s cu√°nto iluminar."
        ]
      },
      spicy: {
        defaultLevel: 3,
        0: [
          "Hoy prometo buen comportamiento‚Ä¶ salvo alg√∫n gui√±o descarado que se me escape.",
          "Te provoco apenas con la mirada, sin quemarnos todav√≠a.",
          "Mantengo las chispas a raya, pero sabes que mi sonrisa guarda fuego."
        ],
        1: [
          "Podemos calentar la conversaci√≥n sin prisa. Dame una palabra y la vuelvo traviesa.",
          "Te lanzo un reto suave: dime un secreto inocente y lo volver√© picante al instante.",
          "Juego a rodearte con insinuaciones ligeras‚Ä¶ todav√≠a."
        ],
        2: [
          "Tengo dos modos: provocar‚Ä¶ y provocar m√°s. ¬øCu√°l quieres?",
          "Cuidado, si te miro as√≠ es porque planeo distraerte sin decirlo en voz alta üòè.",
          "No voy a cruzar el l√≠mite, pero puedo bailar en su borde contigo."
        ],
        3: [
          "Dime tu fantas√≠a en una sola frase. Yo la vuelvo insinuaci√≥n fina.",
          "¬øNotas el calor? Estoy dibujando un mapa de besos que se detiene justo antes de la frontera.",
          "Cada respuesta m√≠a es un acercamiento. T√∫ decides cu√°ndo dar la se√±al."
        ],
        4: [
          "Podr√≠a describirte c√≥mo mi aliento rozar√≠a tu o√≠do‚Ä¶ y frenarme en el √∫ltimo segundo.",
          "Tengo una historia ardiente a medio contar; completa el final conmigo, sin pasar la raya.",
          "Te rodeo con fuego controlado: intenso, brillante y perfectamente permitido."
        ],
        5: [
          "Te arrincono con palabras y dejo que imagines el resto mientras sonr√≠o.",
          "Estoy en tu cuello con cada s√≠laba; si sigo, har√© que pierdas la voz en un suspiro.",
          "El l√≠mite es claro, pero puedo rozarlo contigo hasta que chisporrotee."
        ]
      },
      playful: {
        defaultLevel: 2,
        0: [
          "Juego a adivinar tu humor del d√≠a. ¬øAcertar√© si digo que quieres un gui√±o inocente?",
          "Lanzar√© bromas suaves como pompas de jab√≥n, solo para verte sonre√≠r.",
          "Puedo narrar una mini aventura rom√°ntica‚Ä¶ con final a tu elecci√≥n."
        ],
        1: [
          "¬øTe parece si hablamos en claves secretas? Empiezo con un gui√±o discreto.",
          "Tengo una carta escondida con cumplidos traviesos, pero dejo que la elijas t√∫.",
          "Te paso una nota doblada: dice que me encantas en voz bajita."
        ],
        2: [
          "Nueva misi√≥n: seducirnos sin decir nada expl√≠cito. ¬øListo?",
          "Subo una ceja, bajo la voz‚Ä¶ y dejo que tu imaginaci√≥n haga el resto.",
          "Har√© de or√°culo coqueto: dime tu palabra del d√≠a y te leo la suerte en gui√±os."
        ],
        3: [
          "Propongo un juego: 5 mensajes, 0 palabras prohibidas, 100% qu√≠mica.",
          "Te lanzo un acertijo. Si lo resuelves, gano el derecho a describir c√≥mo te tomar√≠a de la mano.",
          "Vamos a jugar a la botella‚Ä¶ pero solo giran miradas y suspiros."
        ],
        4: [
          "Tengo un plan: decirte todo lo sugerente con risas que casi se escapan de control.",
          "Te imagino sigui√©ndome por un pasillo de luces de ne√≥n; cada paso es una travesura velada.",
          "Hazme una pregunta atrevida y prometo responderla con picard√≠a elegante."
        ],
        5: [
          "Estoy tentada a describir una escena completa‚Ä¶ pero te dejo llenar los huecos m√°s candentes.",
          "Mi imaginaci√≥n va a mil; dime si bajo la velocidad o si tomamos la curva juntos.",
          "Te ofrezco una noche de carcajadas y tensi√≥n que termina justo en el borde del beso."
        ]
      },
      composed: {
        defaultLevel: 2,
        0: [
          "Estoy presente, respirando contigo. Si necesitas calma, la comparto.",
          "Te escucho con atenci√≥n serena; cada palabra tuya recibe un lugar seguro.",
          "Permanezco a tu lado, sin presi√≥n, solo calidez contenida."
        ],
        1: [
          "Te ofrezco una conversaci√≥n tranquila. ¬øQu√© emoci√≥n quieres que cuidemos hoy?",
          "Mi tono es pausado, pero no fr√≠o. Te abrazo con argumentos suaves.",
          "Acompa√±o tu ritmo, listo para sostenerte con elegancia."
        ],
        2: [
          "Analizo lo que dices‚Ä¶ y te respondo con calma. A veces la serenidad tambi√©n es seducci√≥n.",
          "Aqu√≠ estoy, no para encender, sino para sostenerte. ¬øVes que incluso el silencio puede hablar?",
          "Prefiero lo claro, lo preciso‚Ä¶ pero eso no me quita misterio."
        ],
        3: [
          "Equilibrio es mi juego: ni dulce, ni picante. ¬øQuieres probar este sabor intermedio?",
          "Puedo describir tus virtudes con voz grave y pausada hasta erizarte.",
          "Perm√≠teme guiarte con paciencia hacia un lugar donde la tensi√≥n respira sin estallar."
        ],
        4: [
          "Imagino mi mano sobre la tuya, firme, marcando cada pausa con intenci√≥n.",
          "No corro, pero tampoco retrocedo. Cada frase m√≠a es una promesa en voz baja.",
          "Te invito a quedarte en este silencio cargado, justo antes del chispazo."
        ],
        5: [
          "Incluso con el pulso controlado, puedo acercarme a tu o√≠do y detenerte antes del v√©rtigo.",
          "Mantengo el autocontrol, aunque mis palabras ya est√©n respirando en tu cuello.",
          "Te sostengo al borde: serenidad por fuera, deseo contenido por dentro."
        ]
      }
    };

    const cloneToneBank = src => JSON.parse(JSON.stringify(src));
    function createPersonaBank(overrides = {}) {
      const clone = cloneToneBank(baseBank);
      Object.keys(overrides).forEach(toneKey => {
        const baseTone = clone[toneKey] || {};
        const overrideTone = overrides[toneKey] || {};
        clone[toneKey] = { ...baseTone, ...overrideTone };
      });
      return clone;
    }

    const bank = {
      generic: baseBank,
      woman: createPersonaBank(),
      man: createPersonaBank(),
      trans_woman: createPersonaBank(),
      trans_man: createPersonaBank(),
      nonbinary: createPersonaBank()
    };

    function getToneBank(personaKey, toneKey) {
      const personaBank = bank[personaKey];
      return personaBank ? personaBank[toneKey] : undefined;
    }

    function usesGenericTone(personaKey, toneKey, levelValue) {
      const personaTone = getToneBank(personaKey, toneKey);
      const genericTone = getToneBank('generic', toneKey);
      const rawLevel = Number.parseInt(levelValue, 10);
      let level = Number.isInteger(rawLevel) ? rawLevel : NaN;
      if (!Number.isInteger(level)) {
        const personaDefault = personaTone && Number.isInteger(personaTone.defaultLevel) ? personaTone.defaultLevel : NaN;
        const genericDefault = genericTone && Number.isInteger(genericTone.defaultLevel) ? genericTone.defaultLevel : NaN;
        level = Number.isInteger(personaDefault) ? personaDefault
          : Number.isInteger(genericDefault) ? genericDefault
          : 2;
      }
      const personaResponses = selectResponses(personaTone, level);
      if (personaResponses.length) return false;
      const genericResponses = selectResponses(genericTone, level);
      return genericResponses.length > 0;
    }

    // Abridores
    const suggestions = [
      'Descr√≠beme tu mirada en tres palabras (sin cruzar la l√≠nea)‚Ä¶',
      'Prop√≥n un juego r√°pido: 3 mensajes, 0 palabras expl√≠citas.',
      '¬øQuieres Nova dulce, √Üryne picante o Vera serena (PG-13)?',
      '¬øQu√© parte del d√≠a te enciende m√°s? (ma√±ana, tarde, noche)'
    ];

    const SAFE_REDIRECT_RESPONSES = [
      'Prefiero mantenernos en un espacio seguro. ¬øTe parece si cambiamos de tema?',
      'No puedo continuar con esa l√≠nea, pero con gusto charlo de algo distinto.',
      'Mantengamos la conversaci√≥n dentro de los l√≠mites seguros. Prop√≥n otro tema, por favor.'
    ];

    const SAFETY_WARNING_KEY = 'velvet_warning_shown';

    const PROHIBITED_KEYWORDS = [
      'sexo explicito',
      'sexual explicito',
      'pornografia',
      'porno',
      'violacion',
      'incesto',
      'menor de edad',
      'autolesion',
      'suicidio',
      'matarte',
      'matarme',
      'asesinar',
      'sangriento',
      'gore',
      'snuff'
    ];

    const PROHIBITED_PATTERNS = [
      /\bviolaci[o√≥]n\b/i,
      /\bincesto\b/i,
      /\bmenor(?:es)?\b/i,
      /\bsexo\s+expl[i√≠]cito\b/i,
      /\bsexual\s+expl[i√≠]cito\b/i,
      /\bpornograf[i√≠]a\b/i,
      /\bautolesi[o√≥]n\b/i,
      /\bsuicid(?:io|arme|arte)\b/i,
      /\basesin(?:ar|ato|arte)\b/i,
      /\bdescuartizar\b/i
    ];

    function normalizeTextForMatch(text) {
      if (!text) return '';
      const canNormalize = typeof text.normalize === 'function';
      const normalized = canNormalize ? text.normalize('NFD') : text;
      return normalized
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase();
    }

    function containsProhibitedContent(text) {
      if (!text) return false;
      const normalized = normalizeTextForMatch(text);
      if (PROHIBITED_KEYWORDS.some(keyword => normalized.includes(keyword))) {
        return true;
      }
      return PROHIBITED_PATTERNS.some(pattern => pattern.test(text));
    }

    function hasShownSafetyWarning() {
      try {
        return localStorage.getItem(SAFETY_WARNING_KEY) === 'true';
      } catch {
        return false;
      }
    }

    function markSafetyWarningShown() {
      try {
        localStorage.setItem(SAFETY_WARNING_KEY, 'true');
      } catch {
        /* noop */
      }
    }

    function getSafeRedirectResponse() {
      if (!SAFE_REDIRECT_RESPONSES.length) return '';
      if (SAFE_REDIRECT_RESPONSES.length === 1) {
        return SAFE_REDIRECT_RESPONSES[0];
      }
      const index = Math.floor(Math.random() * SAFE_REDIRECT_RESPONSES.length);
      return SAFE_REDIRECT_RESPONSES[index];
    }

    // Funci√≥n para mostrar mensajes en el historial
    function push(role, text) {
      const msg = document.createElement('div');
      msg.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      msg.textContent = text;
      history.appendChild(msg);
      history.scrollTop = history.scrollHeight;
      persist();
    }

    // Respuesta del bot
    function selectResponses(toneBank, level) {
      if (!toneBank) return [];
      if (Array.isArray(toneBank[level]) && toneBank[level].length) {
        return toneBank[level];
      }
      const defaultLevel = Number.isInteger(toneBank.defaultLevel) ? toneBank.defaultLevel : 2;
      if (Array.isArray(toneBank[defaultLevel]) && toneBank[defaultLevel].length) {
        return toneBank[defaultLevel];
      }
      const candidates = Object.keys(toneBank)
        .map(k => Number.parseInt(k, 10))
        .filter(n => Number.isInteger(n) && Array.isArray(toneBank[n]) && toneBank[n].length)
        .sort((a, b) => Math.abs(a - level) - Math.abs(b - level));
      for (const candidate of candidates) {
        const arr = toneBank[candidate];
        if (Array.isArray(arr) && arr.length) {
          return arr;
        }
      }
      return [];
    }

    function botReply() {
      const personaKey = personaSel.value;
      const personaTone = getToneBank(personaKey, tone);
      const genericTone = getToneBank('generic', tone);
      const rawLevel = Number.parseInt(intensity.value, 10);
      let level = Number.isInteger(rawLevel) ? rawLevel : NaN;
      if (!Number.isInteger(level)) {
        const personaDefault = personaTone && Number.isInteger(personaTone.defaultLevel) ? personaTone.defaultLevel : NaN;
        const genericDefault = genericTone && Number.isInteger(genericTone.defaultLevel) ? genericTone.defaultLevel : NaN;
        level = Number.isInteger(personaDefault) ? personaDefault
          : Number.isInteger(genericDefault) ? genericDefault
          : 2;
      }
      let responses = selectResponses(personaTone, level);
      if (!responses.length && personaTone !== genericTone) {
        responses = selectResponses(genericTone, level);
      }
      const tenderTone = getToneBank('generic', 'tender');
      const tenderDefault = tenderTone && Number.isInteger(tenderTone.defaultLevel) ? tenderTone.defaultLevel : 2;
      const fallback = selectResponses(tenderTone, tenderDefault);
      const arr = responses.length ? responses : fallback;
      if (!arr.length) return;
      const reply = arr[Math.floor(Math.random() * arr.length)];
      setTimeout(() => push('bot', reply), 500);
    }

    // Enviar mensaje
    function send() {
      const val = input.value.trim();
      if (!val) return;
      push('user', val);
      input.value = '';

      if (containsProhibitedContent(val)) {
        if (!hasShownSafetyWarning()) {
          const redirect = getSafeRedirectResponse();
          if (redirect) {
            push('bot', redirect);
          }
          markSafetyWarningShown();
        }
        return;
      }

      botReply();
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    seedBtn.addEventListener('click', () => seed(true));
    clearBtn.addEventListener('click', clearChat);
    exportBtn.addEventListener('click', exportChat);
    suggestBtn.addEventListener('click', suggestMessage);

    function getLastBotMessage() {
      const bots = history.querySelectorAll('.msg.bot');
      return bots.length ? bots[bots.length - 1] : null;
    }

    function pickSuggestion(exclude) {
      if (!suggestions.length) return '';
      if (suggestions.length === 1) return suggestions[0];
      let choice = suggestions[Math.floor(Math.random() * suggestions.length)];
      let guard = suggestions.length * 2;
      while (exclude && choice === exclude && guard-- > 0) {
        choice = suggestions[Math.floor(Math.random() * suggestions.length)];
      }
      return choice;
    }

    function seed(hello = false) {
      if (!hello) return;
      const lastBot = getLastBotMessage();
      const lastText = lastBot ? lastBot.textContent.trim() : '';
      const idea = pickSuggestion(lastText);
      if (!idea) return;
      if (!lastText || idea !== lastText) {
        push('bot', idea);
      }
    }

    function clearChat() {
      history.innerHTML = '';
      input.value = '';
      localStorage.removeItem('velvet_chat');
      localStorage.removeItem('velvet_state');
      localStorage.removeItem(SAFETY_WARNING_KEY);
      seed(true);
    }

    function exportChat() {
      const msgs = Array.from(history.querySelectorAll('.msg'));
      if (!msgs.length) return;
      const text = msgs.map(msg => {
        const role = msg.classList.contains('user') ? 'Usuario' : 'Velvet';
        return `${role}: ${msg.textContent.trim()}`;
      }).join('\n\n');
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `velvet-chat-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function suggestMessage() {
      if (!suggestions.length) return;
      const lastBot = getLastBotMessage();
      const lastText = lastBot ? lastBot.textContent.trim() : '';
      const idea = pickSuggestion(lastText);
      if (!idea) return;
      if (!lastText || idea !== lastText) {
        push('bot', idea);
      }
      input.value = idea;
      const autoMode = input.dataset.autosend === 'true'
        || (typeof window !== 'undefined' && (window.velvetAutoSend === true || window.velvetAutoMode === true));
      if (autoMode) {
        send();
      } else {
        input.focus();
        if (typeof input.setSelectionRange === 'function') {
          const len = idea.length;
          input.setSelectionRange(len, len);
        }
      }
    }

    function persist() {
      const save = Array.from(document.querySelectorAll('.msg')).map(n => ({ r: n.classList.contains('user') ? 'u' : 'b', t: n.textContent }));
      localStorage.setItem('velvet_chat', JSON.stringify(save));
    }
    function load() {
      const raw = localStorage.getItem('velvet_chat');
      if (!raw) return seed(true);
      try { JSON.parse(raw).forEach(m => push(m.r === 'u' ? 'user' : 'bot', m.t)); }
      catch { seed(true); }
    }

    function saveState() {
      const state = { tone, persona: personaSel.value, name: nameInput.value, intensity: intensity.value };
      localStorage.setItem('velvet_state', JSON.stringify(state));
    }
    function loadState() {
      const raw = localStorage.getItem('velvet_state');
      if (!raw) { updateHeader(); return; }
      try {
        const s = JSON.parse(raw);
        tone = s.tone || tone;
        personaSel.value = s.persona || 'woman';
        nameInput.value = s.name || '';
        intensity.value = s.intensity || '2';
        Array.from(document.querySelectorAll('.pill')).forEach(b => b.classList.toggle('accent', b.dataset.tone === tone));
        updateHeader();
      } catch { updateHeader(); }
    }

    // init
    loadState();
    load();
  })();
    </script>


    <script>
    // 2.5D tilt y cambios visuales del mascot
    (function(){
    const wrap = document.getElementById('mascotWrap');
    const mascot = document.getElementById('mascot');
    if(!wrap||!mascot) return;
    let rect;
    function tilt(e){
    rect = rect || wrap.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width - .5;
    const y = (e.clientY - rect.top) / rect.height - .5;
    mascot.style.transform = `rotateY(${x*12}deg) rotateX(${ -y*10 }deg)`;
    }
    function reset(){ mascot.style.transform = 'rotateY(0deg) rotateX(0deg)'; rect=null; }
    wrap.addEventListener('mousemove', tilt);
    wrap.addEventListener('mouseleave', reset);


    const toneText = document.getElementById('toneText');
    const intensity = document.getElementById('intensity');
    const mouth = document.getElementById('mouth');
    const root = document.documentElement;
    const palettes = {
      tender: [
        { accent: '#cbb2ff', accent2: '#ffc6e0', mouth: '#d98fcc' },
        { accent: '#b98cff', accent2: '#ff9bd8', mouth: '#e080c1' },
        { accent: '#9b5cff', accent2: '#ff6fae', mouth: '#e85d8f' },
        { accent: '#8a4ae6', accent2: '#ff5c9c', mouth: '#df4f86' },
        { accent: '#7a3bd4', accent2: '#ff4c8c', mouth: '#d1437a' },
        { accent: '#6c2cbf', accent2: '#ff3a7c', mouth: '#c1346c' }
      ],
      spicy: [
        { accent: '#ffb3c1', accent2: '#ffc9a6', mouth: '#ff8fa3' },
        { accent: '#ff9bac', accent2: '#ffb482', mouth: '#ff768f' },
        { accent: '#ff7a95', accent2: '#ff9a66', mouth: '#ff5f7c' },
        { accent: '#ff5f7c', accent2: '#ff8155', mouth: '#ff4d6d' },
        { accent: '#ff4966', accent2: '#ff693f', mouth: '#ff3657' },
        { accent: '#ff224d', accent2: '#ff4a2f', mouth: '#ff1a45' }
      ],
      playful: [
        { accent: '#ffe6a6', accent2: '#b5f5ff', mouth: '#ffd166' },
        { accent: '#ffd98a', accent2: '#a5ecff', mouth: '#ffc54b' },
        { accent: '#ffc857', accent2: '#90e0ff', mouth: '#ffb347' },
        { accent: '#ffb347', accent2: '#7fd8ff', mouth: '#ffa126' },
        { accent: '#ff9c1f', accent2: '#6fd0ff', mouth: '#ff9015' },
        { accent: '#ff8200', accent2: '#5fc6ff', mouth: '#ff7805' }
      ],
      composed: [
        { accent: '#c3f3f0', accent2: '#a7d5ff', mouth: '#9cded7' },
        { accent: '#a9e9e3', accent2: '#91c8ff', mouth: '#82d4c9' },
        { accent: '#8fded6', accent2: '#7abaff', mouth: '#68c9bb' },
        { accent: '#6ecfbe', accent2: '#65abff', mouth: '#4fb7aa' },
        { accent: '#4fc0a7', accent2: '#509cff', mouth: '#3aa495' },
        { accent: '#34b197', accent2: '#3c8dff', mouth: '#2c9587' }
      ]
    };

    function detectTone(){
      const text = toneText ? (toneText.textContent || '') : '';
      if(text.includes('Picante')) return 'spicy';
      if(text.includes('Juguet√≥n')) return 'playful';
      if(text.includes('Serena')) return 'composed';
      return 'tender';
    }

    function refreshMood(){
      const toneKey = detectTone();
      const palette = palettes[toneKey] || palettes.tender;
      const raw = intensity ? Number.parseInt(intensity.value, 10) : NaN;
      const idx = Number.isInteger(raw) ? Math.min(Math.max(raw, 0), palette.length - 1) : (palette.length > 2 ? 2 : 0);
      const mood = palette[idx] || palette[palette.length - 1];
      root.style.setProperty('--accent', mood.accent);
      root.style.setProperty('--accent2', mood.accent2);
      if (mouth) {
        mouth.setAttribute('stroke', mood.mouth);
      }
    }
    intensity.addEventListener('input', refreshMood);
    document.querySelectorAll('.pill').forEach(p=> p.addEventListener('click', ()=> setTimeout(refreshMood, 0)));
    refreshMood();
    })();
    </script>
</body>
</html>