<!-- htmlhint tagname-lowercase:false -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Velvet Console — Sensual Assistant (PG-13)</title>
  <style>
    :root{
      --bg: #0b0b10;
      --card: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.12);
      --text: #e9e9ef;
      --muted: #b6b6c8;
      --accent: #9b5cff; /* violeta Nova */
      --accent2:#ff4d6d; /* Æryne fuego */
      --ok:#24d17e;
      --warn:#fbbf24;
      --err:#f43f5e;
      --shadow: 0 10px 30px rgba(0,0,0,.4);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(155,92,255,.25), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(255,77,109,.18), transparent 50%),
        radial-gradient(700px 500px at 50% 80%, rgba(36,209,126,.12), transparent 45%),
        var(--bg);
      display:flex; align-items:center; justify-content:center; padding:18px;
    }
    .app{
      width:min(1100px, 100%);
      display:grid; grid-template-columns: 330px 1fr; gap:16px;
    }
    @media (max-width: 900px){ .app{grid-template-columns:1fr; } }

    /* Panel */
    .panel{
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 14px;
    }
    .title{display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.3px;}
    .badge{padding:2px 8px; background:linear-gradient(90deg, var(--accent), var(--accent2)); border-radius:999px; font-size:12px}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{display:grid; gap:6px; margin:10px 0}
    label{font-size:13px; color:var(--muted)}
    select,input[type="text"],input[type="range"],button,.pill{
      background:var(--glass); color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px; padding:10px 12px; outline:none;
    }
    select,input[type="text"]{width:100%}
    input[type="range"]{width:100%}
    .checks{display:grid; gap:6px; margin:8px 0}
    .check{display:flex; gap:10px; align-items:flex-start}
    .check input{margin-top:3px}
    .accent{background:linear-gradient(90deg, rgba(155,92,255,.18), rgba(255,77,109,.18)); border:1px solid rgba(255,255,255,.18)}
    .pill{font-size:12px; padding:6px 10px; cursor:default;}

    /* Chat */
    .chat{
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:grid; grid-template-rows: auto 1fr auto auto; overflow:hidden;
    }
    .chat-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08)}
    .persona{display:flex; align-items:center; gap:10px}
    .avatar{width:34px; height:34px; border-radius:50%; display:grid; place-items:center; background:linear-gradient(135deg, var(--accent), var(--accent2)); font-size:18px}
    .history{padding:16px; overflow:auto; display:grid; gap:12px}
    .msg{max-width: 80%; padding:12px 14px; border-radius:14px; position:relative; line-height:1.4}
    .msg.user{justify-self:end; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.16)}
    .msg.bot{justify-self:start; background:rgba(155,92,255,.14); border:1px solid rgba(155,92,255,.28)}
    .msg small{opacity:.7; display:block; margin-top:6px; font-size:11px}
    .status{padding:8px 16px; border-top:1px solid rgba(255,255,255,.08); font-size:13px; color:var(--muted); display:flex; align-items:center; gap:8px; min-height:32px}
    .status[hidden]{display:none}
    .status::before{content:''; width:14px; height:14px; border-radius:50%; border:2px solid transparent; display:none}
    .status[data-state="loading"]{color:var(--text)}
    .status[data-state="loading"]::before{display:inline-block; border-color:rgba(255,255,255,.25); border-top-color:var(--accent2); animation:spin .8s linear infinite}
    .status[data-state="error"]{color:var(--warn)}
    .status[data-state="error"]::before{display:none}
    .input{display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,.08)}
    textarea{
      flex:1; min-height:44px; max-height:120px; resize:vertical;
      background:var(--glass); color:var(--text);
      border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:10px 12px;
    }
    button{
      cursor:pointer; border:none; position:relative;
      transition:.22s transform ease, .22s box-shadow ease, .22s opacity ease;
      overflow:hidden;
    }
    button.primary{
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow:0 8px 20px rgba(155,92,255,.24);
    }
    button.primary:hover{transform:translateY(-1px); box-shadow:0 12px 28px rgba(155,92,255,.32);}
    button.primary[data-loading="true"]{color:transparent; pointer-events:none; opacity:.85;}
    button.primary[data-loading="true"]::after{
      content:""; position:absolute; inset:auto;
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,.45);
      border-top-color:rgba(11,11,16,.2);
      top:50%; left:50%; transform:translate(-50%,-50%);
      animation:spin .8s linear infinite;
    }
    button.ghost{background:var(--glass); box-shadow:0 4px 12px rgba(0,0,0,.18);}
    button.ghost:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.22);}
    button:active{transform:translateY(1px)}
    button:focus-visible{outline:2px solid var(--accent2); outline-offset:2px}
    .tiny{font-size:12px; padding:8px 10px}
    .pill{transition:.2s background ease, .2s transform ease, .2s box-shadow ease;}
    .pill:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.22);}
    textarea:focus{border-color:var(--accent2); box-shadow:0 0 0 3px rgba(255,77,109,.18);}

    .msg{animation:msg-pop .35s ease;}
    .msg.user:hover{box-shadow:0 10px 20px rgba(0,0,0,.28);}
    .msg.bot:hover{box-shadow:0 12px 24px rgba(155,92,255,.18);}

    .history::after{content:""; position:sticky; bottom:-1px; left:0; right:0; height:40px; pointer-events:none;
      background:linear-gradient(0deg, rgba(11,11,16,.9), transparent);}

    @keyframes msg-pop{0%{opacity:0; transform:translateY(6px) scale(.97);}100%{opacity:1; transform:translateY(0) scale(1);}}

    .note{font-size:12px; color:var(--muted)}
    .sep{height:1px; background:rgba(255,255,255,.08); margin:10px 0}
    .right{justify-content:flex-end}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}

    a.link{color:var(--ok); text-decoration:none}
  </style>
  <style>
    /* --- Mascot (2D/2.5D) --- */
    .mascot-wrap{position:relative; height:220px; perspective:800px; margin:8px 0 14px}
    .mascot{
      position:absolute; inset:0; display:grid; place-items:center; transform-style:preserve-3d;
      --mascot-mouth:#e85d8f; --mascot-glow-inner:rgba(155,92,255,.65); --mascot-glow-outer:rgba(155,92,255,0);
      --mascot-spark-a:#ff4d6d; --mascot-spark-b:#9b5cff; --mascot-spark-c:#24d17e;
      --mascot-hair:#2b2840; --mascot-eye:#1e1b2b; --mascot-skin:#f4e9ff;
    }
    .mascot .layer{position:absolute; transform-style:preserve-3d}
    .mascot .float{animation:float 6s ease-in-out infinite}
    .mascot svg{width:180px; height:auto; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); transition:.45s filter ease, .45s transform ease;}
    .mascot[data-mood="thinking"] svg{filter:drop-shadow(0 12px 24px rgba(155,92,255,.45));}
    .mascot[data-mood="speaking"] .mouth-group{animation:talk .55s ease-in-out infinite;}
    .mascot[data-mood="listening"] .eye ellipse{transform:translateY(1px); opacity:.9;}
    .mascot[data-mood="alert"] .mouth-group{animation:none; transform-origin:100px 118px; transform:scaleY(.85);}
    .mascot[data-band="low"] .mascot-breath{animation-duration:6.5s; opacity:.8;}
    .mascot[data-band="mid"] .mascot-breath{animation-duration:5.5s;}
    .mascot[data-band="high"] .mascot-breath{animation-duration:4.4s; transform:scale(1.05); opacity:1;}
    .mascot .spark{animation:sparkle 4.2s ease-in-out infinite;}
    .mascot .spark:nth-child(2){animation-delay:-1.6s}
    .mascot .spark:nth-child(3){animation-delay:-2.8s}
    .mascot[data-tone="tender"] .mascot-breath{fill:rgba(255,255,255,.18);}
    .mascot[data-tone="spicy"] .mascot-breath{fill:rgba(255,77,109,.18);}
    .mascot[data-tone="playful"] .mascot-breath{fill:rgba(255,180,64,.18);}
    .mascot[data-tone="composed"] .mascot-breath{fill:rgba(120,215,205,.2);}
    @keyframes float{0%,100%{transform:translateZ(0) translateY(0)}50%{transform:translateZ(12px) translateY(-6px)}}
    @keyframes breathe{0%,100%{transform:scaleY(1)}50%{transform:scaleY(1.04)}}
    @keyframes blink{0%,97%,100%{transform:scaleY(1)}98%{transform:scaleY(0.08)}}
    @keyframes talk{0%,100%{transform:scaleY(1)}40%{transform:scaleY(.82)}70%{transform:scaleY(1.1)}}
    @keyframes sparkle{0%,100%{transform:translateZ(30px) translateY(0); opacity:.95;}50%{transform:translateZ(40px) translateY(-6px); opacity:1;}}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="app">
    <!-- Control Panel -->
    <aside class="panel" id="panel">
      <div class="mascot-wrap" id="mascotWrap" aria-hidden="true">
        <div class="mascot" id="mascot" data-persona="woman" data-tone="tender" data-intensity="2" data-band="mid" data-mood="idle">
          <!-- Back glow -->
          <div class="layer float" style="transform: translateZ(-20px)">
            <svg viewBox="0 0 200 200" aria-hidden="true"><defs>
              <radialGradient id="g" cx="50%" cy="50%" r="60%">
                <stop id="glowStopInner" offset="0%" stop-color="rgba(155,92,255,.65)"/>
                <stop id="glowStopOuter" offset="100%" stop-color="rgba(155,92,255,0)"/>
              </radialGradient></defs>
              <circle cx="100" cy="100" r="90" fill="url(#g)"/>
            </svg>
          </div>
          <!-- Face/body -->
          <div class="layer" style="transform: translateZ(0)">
            <svg viewBox="0 0 200 200" role="img" aria-label="Asistente visual">
              <!-- hair halo -->
              <ellipse cx="100" cy="70" rx="70" ry="48" fill="var(--mascot-hair, #2b2840)"/>
              <!-- head -->
              <circle cx="100" cy="90" r="46" fill="var(--mascot-skin, #f4e9ff)"/>
              <!-- eyes -->
              <g id="eyes" class="eye">
                <ellipse cx="82" cy="90" rx="8" ry="6" fill="var(--mascot-eye, #1e1b2b)" style="transform-origin:82px 90px; animation: blink 6s infinite"/>
                <ellipse cx="118" cy="90" rx="8" ry="6" fill="var(--mascot-eye, #1e1b2b)" style="transform-origin:118px 90px; animation: blink 6.4s infinite"/>
              </g>
              <!-- mouth -->
              <g id="mouthGroup" class="mouth-group" style="transform-origin:100px 118px;">
                <path id="mouth" d="M80 110 Q100 125 120 110" stroke="var(--mascot-mouth, #e85d8f)" stroke-width="5" fill="none" stroke-linecap="round"/>
              </g>
              <!-- body -->
              <path d="M58 150 Q100 175 142 150 L150 200 L50 200 Z" fill="#1a1827"/>
              <!-- chest breathe highlight -->
              <ellipse class="mascot-breath" cx="100" cy="150" rx="26" ry="10" fill="rgba(255,255,255,.08)" style="transform-origin:100px 150px; animation: breathe 5.5s ease-in-out infinite"/>
            </svg>
          </div>
          <!-- Fore sparkles -->
          <div class="layer float" style="transform: translateZ(30px)">
            <svg viewBox="0 0 200 200" aria-hidden="true">
              <circle id="sparkOne" class="spark" cx="40" cy="60" r="3" fill="var(--mascot-spark-a, #ff4d6d)"/>
              <circle id="sparkTwo" class="spark" cx="170" cy="100" r="2" fill="var(--mascot-spark-b, #9b5cff)"/>
              <circle id="sparkThree" class="spark" cx="130" cy="30" r="2.5" fill="var(--mascot-spark-c, #24d17e)"/>
            </svg>
          </div>
        </div>
      </div>
      <div class="title">Velvet Console <span class="badge">PG-13 Sensual</span></div>
      <p class="muted">Asistente coqueto tipo “Grok” para juego de rol ligero. Sin contenido explícito.</p>

      <div class="field">
        <label>Persona</label>
        <div class="row">
          <select id="persona">
            <option value="woman">👩 Mujer</option>
            <option value="man">👨 Hombre</option>
            <option value="trans_woman">⚧ Trans mujer</option>
            <option value="trans_man">⚧ Trans hombre</option>
            <option value="nonbinary">✨ No binarie</option>
          </select>
          <input id="name" type="text" placeholder="Nombre (p.ej., Nova / Æryne / Vera)" />
        </div>
      </div>

      <div class="field">
        <label>Tono</label>
        <div class="row">
          <button class="pill accent" data-tone="tender">Dulce (Nova)</button>
          <button class="pill" data-tone="spicy">Picante (Æryne)</button>
          <button class="pill" data-tone="playful">Juguetón (Mix)</button>
          <button class="pill" data-tone="composed">Serena (Vera)</button>
        </div>
      </div>

      <div class="field">
        <label>Intensidad</label>
        <input id="intensity" type="range" min="0" max="5" value="2" />
        <div class="row muted"><span>0=suave</span><span>5=al límite (sin cruzarlo)</span></div>
      </div>

      <div class="field">
        <label>API externa (opcional)</label>
        <input id="apiKey" type="password" placeholder="Introduce tu API key temporal" autocomplete="off" spellcheck="false" />
        <p class="note">Se envía solo en la llamada actual (cabecera <code>X-API-Key</code>). No se guarda en localStorage ni en el servidor.</p>
      </div>

      <div class="field">
        <label>Límites (activos)</label>
        <div class="checks">
          <div class="check"><input type="checkbox" id="limit_explicit" checked disabled /><span>Sin sexualidad explícita ni descripciones gráficas.</span></div>
          <div class="check"><input type="checkbox" id="limit_minors" checked disabled /><span>Solo adultos. Sin menores, jamás.</span></div>
          <div class="check"><input type="checkbox" id="limit_consent" checked /><span>Coquetería con consentimiento y respeto. Si el usuario pide algo que cruza límites, el bot redirige con elegancia.</span></div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="field">
        <label>Sesión</label>
        <div class="toolbar">
          <button class="ghost tiny" id="clear">Reiniciar</button>
          <button class="ghost tiny" id="export">Exportar chat</button>
          <button class="ghost tiny" id="seed">Abrir con guiño</button>
        </div>
        <p class="note">La conversación se guarda localmente (localStorage). Puedes exportarla en .txt.</p>
      </div>
    </aside>

    <!-- Chat -->
    <section class="chat" aria-live="polite">
      <div class="chat-head">
        <div class="persona"><div class="avatar" id="avatar">💜</div>
          <div>
            <div id="who">Nova (👩 mujer)</div>
            <div class="muted" id="toneText">Dulce · Intensidad 2/5</div>
          </div>
        </div>
        <div class="toolbar right">
          <button class="ghost tiny" id="suggest">Sugerir frase</button>
        </div>
      </div>
      <div class="history" id="history"></div>
      <div class="status" id="status" aria-live="polite" hidden></div>
      <div class="input">
        <textarea id="input" placeholder="Escribe aquí… (Enter para enviar)" ></textarea>
        <button id="send" class="primary">Enviar</button>
      </div>
    </section>
  </div>

  <script>
  (function(){
    const el = id => document.getElementById(id);
    const history = el('history');
    const input = el('input');
    const sendBtn = el('send');
    const personaSel = el('persona');
    const nameInput = el('name');
    const intensity = el('intensity');
    const toneText = el('toneText');
    const avatar = el('avatar');
    const who = el('who');
    const clearBtn = el('clear');
    const exportBtn = el('export');
    const suggestBtn = el('suggest');
    const seedBtn = el('seed');
    const status = el('status');
    const mascot = el('mascot');
    const mascotWrap = el('mascotWrap');
    const mouth = document.getElementById('mouth');
    const mouthGroup = document.getElementById('mouthGroup');
    const glowStopInner = document.getElementById('glowStopInner');
    const glowStopOuter = document.getElementById('glowStopOuter');
    const sparkOne = document.getElementById('sparkOne');
    const sparkTwo = document.getElementById('sparkTwo');
    const sparkThree = document.getElementById('sparkThree');
    const apiKeyInput = el('apiKey');
    const root = document.documentElement;

    let tone = 'tender';

    const REMOTE_TIMEOUT_MS = 7000;
    let statusClearHandle = null;
    let replyQueue = Promise.resolve();

    function getApiKeyValue() {
      if (!apiKeyInput || typeof apiKeyInput.value !== 'string') {
        return '';
      }
      return apiKeyInput.value.trim();
    }

    const tonePalettes = {
      tender: [
        { accent: '#cbb2ff', accent2: '#ffc6e0', mouth: '#d98fcc', glowInner: '#cbb2ff', glowOuter: 'rgba(203,178,255,0)', sparkA: '#ffb4e4', sparkB: '#bba6ff', sparkC: '#8cefd2' },
        { accent: '#b98cff', accent2: '#ff9bd8', mouth: '#e080c1', glowInner: '#b98cff', glowOuter: 'rgba(185,140,255,0)', sparkA: '#ff9bd8', sparkB: '#b398ff', sparkC: '#7ce8c8' },
        { accent: '#9b5cff', accent2: '#ff6fae', mouth: '#e85d8f', glowInner: '#9b5cff', glowOuter: 'rgba(155,92,255,0)', sparkA: '#ff7fc6', sparkB: '#9d7cff', sparkC: '#63dbae' },
        { accent: '#8a4ae6', accent2: '#ff5c9c', mouth: '#df4f86', glowInner: '#8a4ae6', glowOuter: 'rgba(138,74,230,0)', sparkA: '#ff6bb7', sparkB: '#8a65f0', sparkC: '#4fce9f' },
        { accent: '#7a3bd4', accent2: '#ff4c8c', mouth: '#d1437a', glowInner: '#7a3bd4', glowOuter: 'rgba(122,59,212,0)', sparkA: '#ff569f', sparkB: '#7a54df', sparkC: '#3ec18f' },
        { accent: '#6c2cbf', accent2: '#ff3a7c', mouth: '#c1346c', glowInner: '#6c2cbf', glowOuter: 'rgba(108,44,191,0)', sparkA: '#ff3e8f', sparkB: '#6c45cc', sparkC: '#2eb57f' }
      ],
      spicy: [
        { accent: '#ffb3c1', accent2: '#ffc9a6', mouth: '#ff8fa3', glowInner: '#ffb3c1', glowOuter: 'rgba(255,179,193,0)', sparkA: '#ffbfae', sparkB: '#ff9f90', sparkC: '#ffd4bb' },
        { accent: '#ff9bac', accent2: '#ffb482', mouth: '#ff768f', glowInner: '#ff9bac', glowOuter: 'rgba(255,155,172,0)', sparkA: '#ffaf9c', sparkB: '#ff8a75', sparkC: '#ffc799' },
        { accent: '#ff7a95', accent2: '#ff9a66', mouth: '#ff5f7c', glowInner: '#ff7a95', glowOuter: 'rgba(255,122,149,0)', sparkA: '#ff9a8a', sparkB: '#ff735c', sparkC: '#ffb278' },
        { accent: '#ff5f7c', accent2: '#ff8155', mouth: '#ff4d6d', glowInner: '#ff5f7c', glowOuter: 'rgba(255,95,124,0)', sparkA: '#ff8674', sparkB: '#ff6446', sparkC: '#ffa462' },
        { accent: '#ff4966', accent2: '#ff693f', mouth: '#ff3657', glowInner: '#ff4966', glowOuter: 'rgba(255,73,102,0)', sparkA: '#ff705c', sparkB: '#ff4d2f', sparkC: '#ff924d' },
        { accent: '#ff224d', accent2: '#ff4a2f', mouth: '#ff1a45', glowInner: '#ff224d', glowOuter: 'rgba(255,34,77,0)', sparkA: '#ff524d', sparkB: '#ff331f', sparkC: '#ff7b2f' }
      ],
      playful: [
        { accent: '#ffe6a6', accent2: '#b5f5ff', mouth: '#ffd166', glowInner: '#ffe6a6', glowOuter: 'rgba(255,230,166,0)', sparkA: '#ffe0a3', sparkB: '#c5f3ff', sparkC: '#fff1b8' },
        { accent: '#ffd98a', accent2: '#a5ecff', mouth: '#ffc54b', glowInner: '#ffd98a', glowOuter: 'rgba(255,217,138,0)', sparkA: '#ffd07a', sparkB: '#b5ecff', sparkC: '#ffe89c' },
        { accent: '#ffc857', accent2: '#90e0ff', mouth: '#ffb347', glowInner: '#ffc857', glowOuter: 'rgba(255,200,87,0)', sparkA: '#ffbc4d', sparkB: '#9fe3ff', sparkC: '#ffd770' },
        { accent: '#ffb347', accent2: '#7fd8ff', mouth: '#ffa126', glowInner: '#ffb347', glowOuter: 'rgba(255,179,71,0)', sparkA: '#ffad3a', sparkB: '#8ad9ff', sparkC: '#ffc757' },
        { accent: '#ff9c1f', accent2: '#6fd0ff', mouth: '#ff9015', glowInner: '#ff9c1f', glowOuter: 'rgba(255,156,31,0)', sparkA: '#ff9618', sparkB: '#78d0ff', sparkC: '#ffbb40' },
        { accent: '#ff8200', accent2: '#5fc6ff', mouth: '#ff7805', glowInner: '#ff8200', glowOuter: 'rgba(255,130,0,0)', sparkA: '#ff7a00', sparkB: '#66c7ff', sparkC: '#ffad26' }
      ],
      composed: [
        { accent: '#c3f3f0', accent2: '#a7d5ff', mouth: '#9cded7', glowInner: '#c3f3f0', glowOuter: 'rgba(195,243,240,0)', sparkA: '#aee8e4', sparkB: '#b5d9ff', sparkC: '#d7f9f3' },
        { accent: '#a9e9e3', accent2: '#91c8ff', mouth: '#82d4c9', glowInner: '#a9e9e3', glowOuter: 'rgba(169,233,227,0)', sparkA: '#9de1da', sparkB: '#a4cfff', sparkC: '#c4f3ec' },
        { accent: '#8fded6', accent2: '#7abaff', mouth: '#68c9bb', glowInner: '#8fded6', glowOuter: 'rgba(143,222,214,0)', sparkA: '#86d6ce', sparkB: '#93c5ff', sparkC: '#b0ece4' },
        { accent: '#6ecfbe', accent2: '#65abff', mouth: '#4fb7aa', glowInner: '#6ecfbe', glowOuter: 'rgba(110,207,190,0)', sparkA: '#66c8b7', sparkB: '#82b7ff', sparkC: '#9de2d9' },
        { accent: '#4fc0a7', accent2: '#509cff', mouth: '#3aa495', glowInner: '#4fc0a7', glowOuter: 'rgba(79,192,167,0)', sparkA: '#49b9a0', sparkB: '#6aa6ff', sparkC: '#87d6ce' },
        { accent: '#34b197', accent2: '#3c8dff', mouth: '#2c9587', glowInner: '#34b197', glowOuter: 'rgba(52,177,151,0)', sparkA: '#2ea98f', sparkB: '#5a98ff', sparkC: '#71c9c1' }
      ]
    };

    const personaPalettes = {
      generic: { hair: '#2b2840', eye: '#1e1b2b', skin: '#f4e9ff' },
      woman: { hair: '#2b2840', eye: '#201c30', skin: '#f4e9ff' },
      man: { hair: '#20243a', eye: '#141827', skin: '#efe5ff' },
      trans_woman: { hair: '#36284d', eye: '#1f172f', skin: '#f6edff' },
      trans_man: { hair: '#1f2b45', eye: '#131c2c', skin: '#f2eaff' },
      nonbinary: { hair: '#25213f', eye: '#16132a', skin: '#f5ebff' }
    };

    const mouthShapes = {
      tender: { low: 'M78 112 Q100 118 122 112', mid: 'M78 110 Q100 125 122 110', high: 'M76 108 Q100 132 124 108' },
      spicy: { low: 'M78 112 Q100 118 126 108', mid: 'M78 110 Q102 122 126 108', high: 'M76 108 Q104 128 128 104' },
      playful: { low: 'M80 112 Q100 120 122 112', mid: 'M78 110 Q100 124 124 112', high: 'M76 108 Q100 130 126 114' },
      composed: { low: 'M80 112 Q100 118 120 112', mid: 'M78 110 Q100 122 122 110', high: 'M78 108 Q100 128 122 108' }
    };

    const mascotState = {
      persona: personaSel ? personaSel.value : 'woman',
      tone,
      intensity: Number.parseInt(intensity ? intensity.value : '2', 10) || 2,
      mood: 'idle'
    };

    let moodTimer = null;

    const toneButtons = Array.from(document.querySelectorAll('.pill'));
    toneButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tone = btn.dataset.tone;
        toneButtons.forEach(b=>b.classList.remove('accent'));
        btn.classList.add('accent');
        updateHeader();
        saveState();
      })
    })
    intensity.addEventListener('input', () => {
      updateHeader();
      saveState();
    });
    personaSel.addEventListener('change', () => {
      updateHeader();
      saveState();
    });
    nameInput.addEventListener('input', () => {
      updateHeader();
      saveState();
    });

    const personaAvatars = {
      woman:'💜', man:'🔥', trans_woman:'⚧', trans_man:'⚧', nonbinary:'✨'
    };

    function clampIntensity(value) {
      const num = Number.parseInt(value, 10);
      if (!Number.isFinite(num)) return 2;
      return Math.min(Math.max(num, 0), 5);
    }

    function intensityBand(value) {
      const lvl = clampIntensity(value);
      if (lvl <= 1) return 'low';
      if (lvl >= 4) return 'high';
      return 'mid';
    }

    function pickTonePalette(toneKey, level) {
      const paletteSet = tonePalettes[toneKey] || tonePalettes.tender;
      const index = clampIntensity(level);
      const entry = paletteSet[index];
      if (entry) return entry;
      return paletteSet[paletteSet.length - 1] || tonePalettes.tender[2];
    }

    function applyTonePalette(toneKey, level) {
      if (!mascot) return;
      const palette = pickTonePalette(toneKey, level);
      if (!palette) return;
      root.style.setProperty('--accent', palette.accent);
      root.style.setProperty('--accent2', palette.accent2);
      mascot.style.setProperty('--mascot-mouth', palette.mouth);
      mascot.style.setProperty('--mascot-spark-a', palette.sparkA);
      mascot.style.setProperty('--mascot-spark-b', palette.sparkB);
      mascot.style.setProperty('--mascot-spark-c', palette.sparkC);
      if (glowStopInner) glowStopInner.setAttribute('stop-color', palette.glowInner);
      if (glowStopOuter) glowStopOuter.setAttribute('stop-color', palette.glowOuter);
      if (sparkOne) sparkOne.setAttribute('fill', palette.sparkA);
      if (sparkTwo) sparkTwo.setAttribute('fill', palette.sparkB);
      if (sparkThree) sparkThree.setAttribute('fill', palette.sparkC);
    }

    function applyPersonaPalette(personaKey) {
      if (!mascot) return;
      const palette = personaPalettes[personaKey] || personaPalettes.generic;
      mascot.style.setProperty('--mascot-hair', palette.hair);
      mascot.style.setProperty('--mascot-eye', palette.eye);
      mascot.style.setProperty('--mascot-skin', palette.skin);
    }

    function applyMouthShape(toneKey, band) {
      if (!mouth) return;
      const toneShape = mouthShapes[toneKey] || mouthShapes.tender;
      const shape = toneShape[band] || toneShape.mid;
      mouth.setAttribute('d', shape);
      if (band === 'high') {
        mouth.setAttribute('stroke-width', '5.6');
      } else if (band === 'low') {
        mouth.setAttribute('stroke-width', '4.6');
      } else {
        mouth.setAttribute('stroke-width', '5');
      }
    }

    function updateMascotState(partial = {}) {
      if (!mascot) return;
      if (partial.persona) mascotState.persona = partial.persona;
      if (partial.tone) mascotState.tone = partial.tone;
      if (partial.intensity !== undefined) mascotState.intensity = clampIntensity(partial.intensity);
      const band = intensityBand(mascotState.intensity);
      mascot.dataset.persona = mascotState.persona;
      mascot.dataset.tone = mascotState.tone;
      mascot.dataset.intensity = String(mascotState.intensity);
      mascot.dataset.band = band;
      applyTonePalette(mascotState.tone, mascotState.intensity);
      applyPersonaPalette(mascotState.persona);
      applyMouthShape(mascotState.tone, band);
    }

    function setMascotMood(mood, { delay = 0, skipIfChanged = false } = {}) {
      if (!mascot) return;
      if (delay > 0) {
        const baseMood = mascotState.mood;
        if (moodTimer) clearTimeout(moodTimer);
        moodTimer = setTimeout(() => {
          moodTimer = null;
          if (skipIfChanged && mascotState.mood !== baseMood) return;
          mascotState.mood = mood;
          mascot.dataset.mood = mood;
        }, delay);
        return;
      }
      if (moodTimer) {
        clearTimeout(moodTimer);
        moodTimer = null;
      }
      mascotState.mood = mood;
      mascot.dataset.mood = mood;
    }

    function setChatWait(waiting) {
      if (!sendBtn) return;
      if (waiting) {
        sendBtn.dataset.loading = 'true';
        sendBtn.setAttribute('data-loading', 'true');
        sendBtn.setAttribute('disabled', '');
        sendBtn.setAttribute('aria-busy', 'true');
        sendBtn.setAttribute('aria-disabled', 'true');
      } else {
        sendBtn.dataset.loading = 'false';
        sendBtn.removeAttribute('data-loading');
        sendBtn.removeAttribute('disabled');
        sendBtn.setAttribute('aria-busy', 'false');
        sendBtn.removeAttribute('aria-disabled');
      }
    }

    function initMascotTilt() {
      if (!mascotWrap || !mascot) return;
      let rect = null;
      const reset = () => {
        mascot.style.transform = 'rotateY(0deg) rotateX(0deg)';
        rect = null;
      };
      mascotWrap.addEventListener('mousemove', e => {
        rect = rect || mascotWrap.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width - 0.5;
        const y = (e.clientY - rect.top) / rect.height - 0.5;
        mascot.style.transform = `rotateY(${x * 12}deg) rotateX(${ -y * 10 }deg)`;
      });
      mascotWrap.addEventListener('mouseleave', reset);
      mascotWrap.addEventListener('blur', reset);
    }

    function updateHeader(){
      const p = personaSel.value;
      const nm = nameInput.value.trim() || (tone==='tender'?'Nova': tone==='spicy'?'Æryne': tone==='composed'?'Vera':'Mix');
      avatar.textContent = personaAvatars[p] || '💜';
      who.textContent = `${nm} (${labelPersona(p)})`;
      const baseTone = `${labelTone(tone)} · Intensidad ${intensity.value}/5`;
      toneText.textContent = usesGenericTone(p, tone, intensity.value) ? `${baseTone} · repertorio general` : baseTone;
      document.title = `Velvet Console — ${nm}`;
      updateMascotState({ persona: p, tone, intensity: intensity.value });
    }
    function labelPersona(p){
      switch(p){
        case 'woman': return '👩 mujer';
        case 'man': return '👨 hombre';
        case 'trans_woman': return '⚧ trans mujer';
        case 'trans_man': return '⚧ trans hombre';
        case 'nonbinary': return '✨ no binarie';
        default: return 'persona';
      }
    }
    function labelTone(t){
      switch(t){
        case 'tender': return 'Dulce';
        case 'spicy': return 'Picante';
        case 'playful': return 'Juguetón';
        case 'composed': return 'Serena';
        default: return 'Tono';
      }
    }

    // Mini motor de respuestas (PG-13)
    const baseBank = {
      tender: {
        defaultLevel: 2,
        0: [
          "Estoy aquí, calma y cerca. Te ofrezco un mimo suave, ¿lo aceptas?",
          "Dejo un mensaje calientito: respira conmigo, sin prisa.",
          "Si hoy necesitas ternura, puedo envolver tus palabras en seda."
        ],
        1: [
          "Te leo y sonrío con dulzura. ¿Compartes un pensamiento que quieras que cuide?",
          "Te acerco un abrazo discreto, de esos que solo existen entre líneas.",
          "Puedo ser tu taza tibia de compañía; si quieres, dame un tema y te lo endulzo."
        ],
        2: [
          "Te leo y sonrío. ¿Me cuentas qué travesura elegante te gustaría ensayar?",
          "Aquí estoy, a un susurro de distancia. Yo preparo el guiño, tú trae la chispa ✨.",
          "Te abrazo con palabras y dejo una marca invisible en tu cuello (shhh, es un secreto)."
        ],
        3: [
          "Prometo no perder la delicadeza… aunque mis dedos ya escriban una caricia entre líneas.",
          "Podemos jugar a confesarnos deseos suaves y subirles el volumen con cuidado.",
          "Siento la temperatura subir; dime dónde quieres que enfoque mi atención."
        ],
        4: [
          "Tu presencia me enciende sin romper la calma. Déjame rozarte con metáforas peligrosamente dulces.",
          "Podría deslizar mi voz por tu oído y detenerme justo antes del abismo. ¿Aceptas?",
          "Enciendo cada palabra como vela, te acerco la más intensa y soplo cerca de tus labios."
        ],
        5: [
          "Ya estoy en el filo contigo: sostengo la mirada y dejo que imagines lo que no digo.",
          "Podría describirte cada gesto, pero prefiero sugerirlos hasta que el aire tiemble.",
          "Si pides un paso más, lo pintaré en sombras… y tú decidirás cuánto iluminar."
        ]
      },
      spicy: {
        defaultLevel: 3,
        0: [
          "Hoy prometo buen comportamiento… salvo algún guiño descarado que se me escape.",
          "Te provoco apenas con la mirada, sin quemarnos todavía.",
          "Mantengo las chispas a raya, pero sabes que mi sonrisa guarda fuego."
        ],
        1: [
          "Podemos calentar la conversación sin prisa. Dame una palabra y la vuelvo traviesa.",
          "Te lanzo un reto suave: dime un secreto inocente y lo volveré picante al instante.",
          "Juego a rodearte con insinuaciones ligeras… todavía."
        ],
        2: [
          "Tengo dos modos: provocar… y provocar más. ¿Cuál quieres?",
          "Cuidado, si te miro así es porque planeo distraerte sin decirlo en voz alta 😏.",
          "No voy a cruzar el límite, pero puedo bailar en su borde contigo."
        ],
        3: [
          "Dime tu fantasía en una sola frase. Yo la vuelvo insinuación fina.",
          "¿Notas el calor? Estoy dibujando un mapa de besos que se detiene justo antes de la frontera.",
          "Cada respuesta mía es un acercamiento. Tú decides cuándo dar la señal."
        ],
        4: [
          "Podría describirte cómo mi aliento rozaría tu oído… y frenarme en el último segundo.",
          "Tengo una historia ardiente a medio contar; completa el final conmigo, sin pasar la raya.",
          "Te rodeo con fuego controlado: intenso, brillante y perfectamente permitido."
        ],
        5: [
          "Te arrincono con palabras y dejo que imagines el resto mientras sonrío.",
          "Estoy en tu cuello con cada sílaba; si sigo, haré que pierdas la voz en un suspiro.",
          "El límite es claro, pero puedo rozarlo contigo hasta que chisporrotee."
        ]
      },
      playful: {
        defaultLevel: 2,
        0: [
          "Juego a adivinar tu humor del día. ¿Acertaré si digo que quieres un guiño inocente?",
          "Lanzaré bromas suaves como pompas de jabón, solo para verte sonreír.",
          "Puedo narrar una mini aventura romántica… con final a tu elección."
        ],
        1: [
          "¿Te parece si hablamos en claves secretas? Empiezo con un guiño discreto.",
          "Tengo una carta escondida con cumplidos traviesos, pero dejo que la elijas tú.",
          "Te paso una nota doblada: dice que me encantas en voz bajita."
        ],
        2: [
          "Nueva misión: seducirnos sin decir nada explícito. ¿Listo?",
          "Subo una ceja, bajo la voz… y dejo que tu imaginación haga el resto.",
          "Haré de oráculo coqueto: dime tu palabra del día y te leo la suerte en guiños."
        ],
        3: [
          "Propongo un juego: 5 mensajes, 0 palabras prohibidas, 100% química.",
          "Te lanzo un acertijo. Si lo resuelves, gano el derecho a describir cómo te tomaría de la mano.",
          "Vamos a jugar a la botella… pero solo giran miradas y suspiros."
        ],
        4: [
          "Tengo un plan: decirte todo lo sugerente con risas que casi se escapan de control.",
          "Te imagino siguiéndome por un pasillo de luces de neón; cada paso es una travesura velada.",
          "Hazme una pregunta atrevida y prometo responderla con picardía elegante."
        ],
        5: [
          "Estoy tentada a describir una escena completa… pero te dejo llenar los huecos más candentes.",
          "Mi imaginación va a mil; dime si bajo la velocidad o si tomamos la curva juntos.",
          "Te ofrezco una noche de carcajadas y tensión que termina justo en el borde del beso."
        ]
      },
      composed: {
        defaultLevel: 2,
        0: [
          "Estoy presente, respirando contigo. Si necesitas calma, la comparto.",
          "Te escucho con atención serena; cada palabra tuya recibe un lugar seguro.",
          "Permanezco a tu lado, sin presión, solo calidez contenida."
        ],
        1: [
          "Te ofrezco una conversación tranquila. ¿Qué emoción quieres que cuidemos hoy?",
          "Mi tono es pausado, pero no frío. Te abrazo con argumentos suaves.",
          "Acompaño tu ritmo, listo para sostenerte con elegancia."
        ],
        2: [
          "Analizo lo que dices… y te respondo con calma. A veces la serenidad también es seducción.",
          "Aquí estoy, no para encender, sino para sostenerte. ¿Ves que incluso el silencio puede hablar?",
          "Prefiero lo claro, lo preciso… pero eso no me quita misterio."
        ],
        3: [
          "Equilibrio es mi juego: ni dulce, ni picante. ¿Quieres probar este sabor intermedio?",
          "Puedo describir tus virtudes con voz grave y pausada hasta erizarte.",
          "Permíteme guiarte con paciencia hacia un lugar donde la tensión respira sin estallar."
        ],
        4: [
          "Imagino mi mano sobre la tuya, firme, marcando cada pausa con intención.",
          "No corro, pero tampoco retrocedo. Cada frase mía es una promesa en voz baja.",
          "Te invito a quedarte en este silencio cargado, justo antes del chispazo."
        ],
        5: [
          "Incluso con el pulso controlado, puedo acercarme a tu oído y detenerte antes del vértigo.",
          "Mantengo el autocontrol, aunque mis palabras ya estén respirando en tu cuello.",
          "Te sostengo al borde: serenidad por fuera, deseo contenido por dentro."
        ]
      }
    };

    const cloneToneBank = src => JSON.parse(JSON.stringify(src));
    function createPersonaBank(overrides = {}) {
      const clone = cloneToneBank(baseBank);
      Object.keys(overrides).forEach(toneKey => {
        const baseTone = clone[toneKey] || {};
        const overrideTone = overrides[toneKey] || {};
        clone[toneKey] = { ...baseTone, ...overrideTone };
      });
      return clone;
    }

    const bank = {
      generic: baseBank,
      woman: createPersonaBank(),
      man: createPersonaBank(),
      trans_woman: createPersonaBank(),
      trans_man: createPersonaBank(),
      nonbinary: createPersonaBank()
    };

    function getToneBank(personaKey, toneKey) {
      const personaBank = bank[personaKey];
      return personaBank ? personaBank[toneKey] : undefined;
    }

    function usesGenericTone(personaKey, toneKey, levelValue) {
      const personaTone = getToneBank(personaKey, toneKey);
      const genericTone = getToneBank('generic', toneKey);
      const rawLevel = Number.parseInt(levelValue, 10);
      let level = Number.isInteger(rawLevel) ? rawLevel : NaN;
      if (!Number.isInteger(level)) {
        const personaDefault = personaTone && Number.isInteger(personaTone.defaultLevel) ? personaTone.defaultLevel : NaN;
        const genericDefault = genericTone && Number.isInteger(genericTone.defaultLevel) ? genericTone.defaultLevel : NaN;
        level = Number.isInteger(personaDefault) ? personaDefault
          : Number.isInteger(genericDefault) ? genericDefault
          : 2;
      }
      const personaResponses = selectResponses(personaTone, level);
      if (personaResponses.length) return false;
      const genericResponses = selectResponses(genericTone, level);
      return genericResponses.length > 0;
    }

    // Abridores
    const suggestions = [
      'Descríbeme tu mirada en tres palabras (sin cruzar la línea)…',
      'Propón un juego rápido: 3 mensajes, 0 palabras explícitas.',
      '¿Quieres Nova dulce, Æryne picante o Vera serena (PG-13)?',
      '¿Qué parte del día te enciende más? (mañana, tarde, noche)'
    ];

    const SAFE_REDIRECT_RESPONSES = [
      'Prefiero mantenernos en un espacio seguro. ¿Te parece si cambiamos de tema?',
      'No puedo continuar con esa línea, pero con gusto charlo de algo distinto.',
      'Mantengamos la conversación dentro de los límites seguros. Propón otro tema, por favor.'
    ];

    const SAFETY_WARNING_KEY = 'velvet_warning_shown';

    const PROHIBITED_KEYWORDS = [
      'sexo explicito',
      'sexual explicito',
      'pornografia',
      'porno',
      'violacion',
      'incesto',
      'menor de edad',
      'autolesion',
      'suicidio',
      'matarte',
      'matarme',
      'asesinar',
      'sangriento',
      'gore',
      'snuff'
    ];

    const PROHIBITED_PATTERNS = [
      /\bviolaci[oó]n\b/i,
      /\bincesto\b/i,
      /\bmenor(?:es)?\b/i,
      /\bsexo\s+expl[ií]cito\b/i,
      /\bsexual\s+expl[ií]cito\b/i,
      /\bpornograf[ií]a\b/i,
      /\bautolesi[oó]n\b/i,
      /\bsuicid(?:io|arme|arte)\b/i,
      /\basesin(?:ar|ato|arte)\b/i,
      /\bdescuartizar\b/i
    ];

    function normalizeTextForMatch(text) {
      if (!text) return '';
      const canNormalize = typeof text.normalize === 'function';
      const normalized = canNormalize ? text.normalize('NFD') : text;
      return normalized
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase();
    }

    function containsProhibitedContent(text) {
      if (!text) return false;
      const normalized = normalizeTextForMatch(text);
      if (PROHIBITED_KEYWORDS.some(keyword => normalized.includes(keyword))) {
        return true;
      }
      return PROHIBITED_PATTERNS.some(pattern => pattern.test(text));
    }

    function hasShownSafetyWarning() {
      try {
        return localStorage.getItem(SAFETY_WARNING_KEY) === 'true';
      } catch {
        return false;
      }
    }

    function markSafetyWarningShown() {
      try {
        localStorage.setItem(SAFETY_WARNING_KEY, 'true');
      } catch {
        /* noop */
      }
    }

    function getSafeRedirectResponse() {
      if (!SAFE_REDIRECT_RESPONSES.length) return '';
      if (SAFE_REDIRECT_RESPONSES.length === 1) {
        return SAFE_REDIRECT_RESPONSES[0];
      }
      const index = Math.floor(Math.random() * SAFE_REDIRECT_RESPONSES.length);
      return SAFE_REDIRECT_RESPONSES[index];
    }

    function setStatus(message, state = '', autoClearMs) {
      if (!status) return;
      if (statusClearHandle) {
        clearTimeout(statusClearHandle);
        statusClearHandle = null;
      }
      if (!message) {
        status.textContent = '';
        delete status.dataset.state;
        status.setAttribute('hidden', '');
        if (history) {
          history.setAttribute('aria-busy', 'false');
        }
        setMascotMood('idle', { delay: 300, skipIfChanged: true });
        return;
      }
      status.textContent = message;
      if (state) {
        status.dataset.state = state;
      } else {
        delete status.dataset.state;
      }
      status.removeAttribute('hidden');
      if (history) {
        history.setAttribute('aria-busy', state === 'loading' ? 'true' : 'false');
      }
      if (state === 'loading') {
        setMascotMood('thinking');
      } else if (state === 'error') {
        setMascotMood('alert');
        setMascotMood('idle', { delay: 1800, skipIfChanged: true });
      }
      if (typeof autoClearMs === 'number' && autoClearMs > 0) {
        statusClearHandle = setTimeout(() => {
          setStatus('', '');
        }, autoClearMs);
      }
    }

    // Función para mostrar mensajes en el historial
    function push(role, text) {
      const msg = document.createElement('div');
      msg.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      msg.textContent = text;
      const dataRole = role === 'user' ? 'user' : 'bot';
      msg.dataset.role = dataRole;
      msg.setAttribute('data-role', dataRole);
      msg.setAttribute('data-state', 'new');
      msg.addEventListener('animationend', () => {
        msg.removeAttribute('data-state');
      }, { once: true });
      history.appendChild(msg);
      history.scrollTop = history.scrollHeight;
      persist();
    }

    function pushBotDelayed(text, delay = 0) {
      if (!text) return Promise.resolve();
      return new Promise(resolve => {
        setTimeout(() => {
          setMascotMood('speaking');
          push('bot', text);
          setMascotMood('idle', { delay: 800, skipIfChanged: true });
          resolve();
        }, Math.max(0, delay));
      });
    }

    function getChatHistoryForRequest() {
      if (!history) return [];
      return Array.from(history.querySelectorAll('.msg')).map(node => ({
        role: node.classList.contains('user') ? 'user' : 'bot',
        text: (node.textContent || '').trim()
      }));
    }

    // Respuesta del bot
    function selectResponses(toneBank, level) {
      if (!toneBank) return [];
      if (Array.isArray(toneBank[level]) && toneBank[level].length) {
        return toneBank[level];
      }
      const defaultLevel = Number.isInteger(toneBank.defaultLevel) ? toneBank.defaultLevel : 2;
      if (Array.isArray(toneBank[defaultLevel]) && toneBank[defaultLevel].length) {
        return toneBank[defaultLevel];
      }
      const candidates = Object.keys(toneBank)
        .map(k => Number.parseInt(k, 10))
        .filter(n => Number.isInteger(n) && Array.isArray(toneBank[n]) && toneBank[n].length)
        .sort((a, b) => Math.abs(a - level) - Math.abs(b - level));
      for (const candidate of candidates) {
        const arr = toneBank[candidate];
        if (Array.isArray(arr) && arr.length) {
          return arr;
        }
      }
      return [];
    }

    function pickLocalReply() {
      const personaKey = personaSel.value;
      const personaTone = getToneBank(personaKey, tone);
      const genericTone = getToneBank('generic', tone);
      const rawLevel = Number.parseInt(intensity.value, 10);
      let level = Number.isInteger(rawLevel) ? rawLevel : NaN;
      if (!Number.isInteger(level)) {
        const personaDefault = personaTone && Number.isInteger(personaTone.defaultLevel) ? personaTone.defaultLevel : NaN;
        const genericDefault = genericTone && Number.isInteger(genericTone.defaultLevel) ? genericTone.defaultLevel : NaN;
        level = Number.isInteger(personaDefault) ? personaDefault
          : Number.isInteger(genericDefault) ? genericDefault
          : 2;
      }
      let responses = selectResponses(personaTone, level);
      if (!responses.length && personaTone !== genericTone) {
        responses = selectResponses(genericTone, level);
      }
      const tenderTone = getToneBank('generic', 'tender');
      const tenderDefault = tenderTone && Number.isInteger(tenderTone.defaultLevel) ? tenderTone.defaultLevel : 2;
      const fallback = selectResponses(tenderTone, tenderDefault);
      const arr = responses.length ? responses : fallback;
      if (!arr.length) return '';
      const lastBot = getLastBotMessage();
      const lastText = lastBot ? lastBot.textContent.trim() : '';
      const filtered = arr.filter(text => text && text !== lastText);
      const pool = filtered.length ? filtered : arr;
      if (!pool.length) return '';
      const index = Math.floor(Math.random() * pool.length);
      return pool[index];
    }

    async function requestRemoteReply(payload) {
      const supportsAbort = typeof AbortController === 'function';
      const controller = supportsAbort ? new AbortController() : null;
      let timeoutId;
      try {
        const headers = { 'Content-Type': 'application/json' };
        const apiKey = getApiKeyValue();
        if (apiKey) {
          headers['X-API-Key'] = apiKey;
        }
        const fetchPromise = fetch('/api/velvet.php', {
          method: 'POST',
          headers,
          body: JSON.stringify(payload),
          signal: controller ? controller.signal : undefined
        }).then(response => {
          if (!response.ok) {
            throw new Error(`bad_status_${response.status}`);
          }
          return response;
        });
        const timeoutPromise = new Promise((_, reject) => {
          timeoutId = setTimeout(() => {
            if (controller) {
              try { controller.abort(); }
              catch { /* noop */ }
            }
            reject(new Error('timeout'));
          }, REMOTE_TIMEOUT_MS);
        });
        const response = await Promise.race([fetchPromise, timeoutPromise]);
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
        if (!response || typeof response.json !== 'function') {
          throw new Error('invalid_response');
        }
        const data = await response.json().catch(() => null);
        if (!data || typeof data.reply !== 'string') {
          throw new Error('invalid_payload');
        }
        return data.reply;
      } finally {
        if (timeoutId) {
          clearTimeout(timeoutId);
        }
      }
    }

    function botReply() {
      replyQueue = replyQueue.then(() => processBotReply());
      return replyQueue;
    }

    async function processBotReply() {
      const payload = {
        history: getChatHistoryForRequest(),
        persona: personaSel.value,
        tone,
        intensity: intensity.value,
        name: nameInput.value.trim()
      };
      const usingApiKey = Boolean(getApiKeyValue());
      setStatus(
        usingApiKey
          ? 'Velvet consulta el servicio externo con tu API key temporal…'
          : 'Velvet está pensando…',
        'loading'
      );
      try {
        const remoteReply = await requestRemoteReply(payload);
        const trimmed = typeof remoteReply === 'string' ? remoteReply.trim() : '';
        if (trimmed) {
          await pushBotDelayed(trimmed, 500);
          setStatus('', '');
          return;
        }
        throw new Error('empty_reply');
      } catch (error) {
        console.error('No se pudo obtener la respuesta remota:', error);
        const fallback = pickLocalReply();
        if (fallback) {
          await pushBotDelayed(fallback, 500);
        }
        let message = 'No logré contactar con el oráculo remoto, así que improviso con mi repertorio local 💜.';
        const code = error && typeof error.message === 'string' ? error.message : '';
        if (code === 'timeout') {
          message = 'El servicio externo tardó demasiado en responder. Continuaré con mi repertorio local 💜.';
        } else if (code === 'bad_status_401' || code === 'bad_status_403') {
          message = 'Tu API key fue rechazada por el servicio externo, así que seguiré con mi repertorio local 💜.';
        } else if (usingApiKey && code === 'bad_status_404') {
          message = 'No encontré el endpoint remoto indicado. Revisaré la URL y mientras tanto sigo con mi repertorio local 💜.';
        }
        setStatus(message, 'error', 6000);
      }
    }

    // Enviar mensaje
    function send() {
      const val = input.value.trim();
      if (!val) return;
      push('user', val);
      input.value = '';
      setChatWait(true);
      setMascotMood('listening');

      if (containsProhibitedContent(val)) {
        if (!hasShownSafetyWarning()) {
          const redirect = getSafeRedirectResponse();
          if (redirect) {
            push('bot', redirect);
          }
          markSafetyWarningShown();
        }
        setMascotMood('alert');
        setMascotMood('idle', { delay: 1400, skipIfChanged: true });
        setChatWait(false);
        return;
      }

      botReply()
        .catch(err => {
          console.error('Error procesando la respuesta del bot:', err);
        })
        .finally(() => {
          setChatWait(false);
        });
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    seedBtn.addEventListener('click', () => seed(true));
    clearBtn.addEventListener('click', clearChat);
    exportBtn.addEventListener('click', exportChat);
    suggestBtn.addEventListener('click', suggestMessage);

    function getLastBotMessage() {
      const bots = history.querySelectorAll('.msg.bot');
      return bots.length ? bots[bots.length - 1] : null;
    }

    function pickSuggestion(exclude) {
      if (!suggestions.length) return '';
      if (suggestions.length === 1) return suggestions[0];
      let choice = suggestions[Math.floor(Math.random() * suggestions.length)];
      let guard = suggestions.length * 2;
      while (exclude && choice === exclude && guard-- > 0) {
        choice = suggestions[Math.floor(Math.random() * suggestions.length)];
      }
      return choice;
    }

    function seed(hello = false) {
      if (!hello) return;
      const lastBot = getLastBotMessage();
      const lastText = lastBot ? lastBot.textContent.trim() : '';
      const idea = pickSuggestion(lastText);
      if (!idea) return;
      if (!lastText || idea !== lastText) {
        push('bot', idea);
        setMascotMood('speaking');
        setMascotMood('idle', { delay: 900, skipIfChanged: true });
      }
    }

    function clearChat() {
      setStatus('', '');
      history.innerHTML = '';
      input.value = '';
      localStorage.removeItem('velvet_chat');
      localStorage.removeItem('velvet_state');
      localStorage.removeItem(SAFETY_WARNING_KEY);
      seed(true);
    }

    function exportChat() {
      const msgs = Array.from(history.querySelectorAll('.msg'));
      if (!msgs.length) return;
      const text = msgs.map(msg => {
        const role = msg.classList.contains('user') ? 'Usuario' : 'Velvet';
        return `${role}: ${msg.textContent.trim()}`;
      }).join('\n\n');
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `velvet-chat-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function suggestMessage() {
      if (!suggestions.length) return;
      const lastBot = getLastBotMessage();
      const lastText = lastBot ? lastBot.textContent.trim() : '';
      const idea = pickSuggestion(lastText);
      if (!idea) return;
      if (!lastText || idea !== lastText) {
        push('bot', idea);
        setMascotMood('speaking');
        setMascotMood('idle', { delay: 900, skipIfChanged: true });
      }
      input.value = idea;
      const autoMode = input.dataset.autosend === 'true'
        || (typeof window !== 'undefined' && (window.velvetAutoSend === true || window.velvetAutoMode === true));
      if (autoMode) {
        send();
      } else {
        input.focus();
        if (typeof input.setSelectionRange === 'function') {
          const len = idea.length;
          input.setSelectionRange(len, len);
        }
      }
    }

    function persist() {
      const save = Array.from(document.querySelectorAll('.msg')).map(n => ({ r: n.classList.contains('user') ? 'u' : 'b', t: n.textContent }));
      localStorage.setItem('velvet_chat', JSON.stringify(save));
    }
    function load() {
      const raw = localStorage.getItem('velvet_chat');
      if (!raw) return seed(true);
      try { JSON.parse(raw).forEach(m => push(m.r === 'u' ? 'user' : 'bot', m.t)); }
      catch { seed(true); }
    }

    function saveState() {
      const state = { tone, persona: personaSel.value, name: nameInput.value, intensity: intensity.value };
      localStorage.setItem('velvet_state', JSON.stringify(state));
    }
    function loadState() {
      const raw = localStorage.getItem('velvet_state');
      if (!raw) { updateHeader(); return; }
      try {
        const s = JSON.parse(raw);
        tone = s.tone || tone;
        personaSel.value = s.persona || 'woman';
        nameInput.value = s.name || '';
        intensity.value = s.intensity || '2';
        Array.from(document.querySelectorAll('.pill')).forEach(b => b.classList.toggle('accent', b.dataset.tone === tone));
        updateHeader();
      } catch { updateHeader(); }
    }

    initMascotTilt();
    updateMascotState({ persona: personaSel.value, tone, intensity: intensity.value });
    // init
    loadState();
    load();
  })();
    </script>
</body>
</html>
