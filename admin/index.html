<!DOCTYPE html>
<html lang="es">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NX2C8N3W');</script>
<!-- End Google Tag Manager -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Blog</title>

  <!-- estilos del sitio para la vista previa -->
  <link rel="preload" href="/css/styles.889d2a038d.css" as="style" onload="this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/styles.889d2a038d.css"></noscript>

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
    }

    body {
      background: #f6f4f1;
      margin: 0;
      font-family: "Inter", "Segoe UI", sans-serif;
    }

    #editor { height: 320px; }

    .admin-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .admin-header {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
      justify-content: space-between;
    }

    .admin-brand__title {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
      color: #2b2b2b;
    }

    .admin-brand__subtitle {
      display: block;
      margin-top: 0.35rem;
      color: #6c6c6c;
      font-size: 0.95rem;
    }

    .admin-status {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.08);
      padding: 1rem 1.25rem;
      min-width: 260px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
    }

    .admin-status--success {
      border-color: rgba(46, 125, 50, 0.4);
      background: #eef8f0;
    }

    .admin-status--error {
      border-color: rgba(211, 47, 47, 0.4);
      background: #fff1f1;
    }

    .admin-status time {
      display: block;
      margin-top: 0.4rem;
      color: #6c6c6c;
      font-size: 0.85rem;
    }

    .admin-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1.3fr);
      gap: 2rem;
    }

    .admin-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .admin-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 1.5rem;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 12px 30px rgba(0,0,0,0.06);
    }

    .admin-card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #2b2b2b;
    }

    .admin-field {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 1rem;
    }

    .admin-field label {
      font-weight: 600;
      color: #2b2b2b;
    }

    .admin-input,
    .admin-field textarea,
    .admin-field select {
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.15);
      padding: 0.65rem 0.75rem;
      font-size: 0.95rem;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .admin-input:focus,
    .admin-field textarea:focus,
    .admin-field select:focus {
      outline: none;
      border-color: #333;
      box-shadow: 0 0 0 3px rgba(0,0,0,0.08);
    }

    .admin-input--error,
    .admin-field textarea.admin-input--error {
      border-color: #d32f2f;
      box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.12);
    }

    .admin-input--ok,
    .admin-field textarea.admin-input--ok {
      border-color: #2e7d32;
    }

    .admin-field__help {
      color: #6c6c6c;
      font-size: 0.85rem;
    }

    .admin-field__message {
      color: #d32f2f;
      font-size: 0.85rem;
      min-height: 1.1rem;
    }

    .admin-field__message--success {
      color: #2e7d32;
    }

    .admin-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
      color: #2b2b2b;
    }

    .admin-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .admin-button {
      border-radius: 999px;
      border: none;
      padding: 0.7rem 1.6rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .admin-button--primary {
      background: #1d1d1d;
      color: #fff;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .admin-button--secondary {
      background: #e6e1da;
      color: #2b2b2b;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .admin-button--ghost {
      background: transparent;
      color: #2b2b2b;
      border: 1px solid rgba(0,0,0,0.2);
    }

    .admin-button:active {
      transform: scale(0.98);
    }

    .admin-preview {
      border-radius: 18px;
      padding: 1.5rem;
      background: #fefefe;
      border: 1px solid rgba(0,0,0,0.08);
    }

    .admin-status-panel {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: #2b2b2b;
    }

    .admin-status-panel ul {
      padding-left: 1.2rem;
      margin: 0;
      color: #d32f2f;
    }

    .admin-section-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #8a7f74;
      margin-bottom: 0.75rem;
      font-weight: 600;
    }

    .admin-required-list {
      margin: 0;
      padding-left: 1.2rem;
      color: #4a4a4a;
      font-size: 0.9rem;
    }

    .admin-required-note {
      margin-top: 0.6rem;
      color: #6c6c6c;
      font-size: 0.85rem;
    }

    .admin-label-required {
      font-size: 0.8rem;
      color: #b85a3f;
      margin-left: 0.35rem;
    }

    .admin-preview .blog-entry {
      margin: 0;
    }

    .admin-preview .blog-entry__title {
      margin-top: 0;
    }

    @media (max-width: 960px) {
      .admin-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NX2C8N3W"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  <div class="admin-shell">
    <header class="admin-header">
      <div class="admin-brand">
        <h1 class="admin-brand__title">Panel editorial del blog</h1>
        <span class="admin-brand__subtitle">La Pluma, el Faro y la Llama</span>
      </div>
      <div id="statusBanner" class="admin-status" role="status" aria-live="polite">
        <strong id="statusTitle">Listo para editar</strong>
        <div id="statusMessage">Completa los campos para guardar y compartir la entrada.</div>
        <time id="statusTimestamp"></time>
      </div>
    </header>

    <main class="admin-layout">
      <aside class="admin-column">
        <section class="admin-card">
          <div class="admin-section-title">Estado</div>
          <div class="admin-status-panel">
            <div><strong>Último guardado:</strong> <span id="lastSaved">Aún no guardado</span></div>
            <div><strong>Errores activos:</strong> <span id="errorCount">0</span></div>
            <ul id="errorList"></ul>
          </div>
        </section>

        <section class="admin-card">
          <div class="admin-section-title">Campos obligatorios</div>
          <ul class="admin-required-list">
            <li>Título del post</li>
            <li>Slug</li>
            <li>Fecha de publicación</li>
            <li>Fragmento (120-240 caracteres)</li>
            <li>Imagen principal</li>
          </ul>
          <div class="admin-required-note">Los mensajes de color verde confirman que el campo está listo.</div>
        </section>

        <section class="admin-card">
          <div class="admin-section-title">Metadata</div>
          <div class="admin-field">
            <label for="postSelect">Seleccionar post</label>
            <select id="postSelect" class="admin-input">
              <option value="">— Nuevo —</option>
            </select>
            <span class="admin-field__help">Carga un post existente o crea uno nuevo.</span>
          </div>
          <div class="admin-field">
            <label for="id">ID</label>
            <input id="id" type="number" class="admin-input">
            <span class="admin-field__help">Si está vacío se generará con la fecha actual.</span>
          </div>
          <div class="admin-field">
            <label for="titulo">Título<span class="admin-label-required">Obligatorio</span></label>
            <input id="titulo" class="admin-input" placeholder="Título inspirador">
            <span class="admin-field__message" id="titulo-message"></span>
          </div>
          <div class="admin-field">
            <label for="slug">Slug<span class="admin-label-required">Obligatorio</span></label>
            <input id="slug" class="admin-input" placeholder="titulo-inspirador">
            <span class="admin-field__help">Se genera automáticamente, pero puedes editarlo.</span>
            <span class="admin-field__message" id="slug-message"></span>
          </div>
          <div class="admin-field">
            <label for="autor">Autor</label>
            <input id="autor" class="admin-input" placeholder="Nombre del autor">
          </div>
          <div class="admin-field">
            <label for="fecha">Fecha (YYYY-MM-DD)<span class="admin-label-required">Obligatorio</span></label>
            <input id="fecha" class="admin-input" placeholder="2024-05-21">
            <span class="admin-field__message" id="fecha-message"></span>
          </div>
          <div class="admin-field">
            <label for="tiempo">Tiempo de lectura</label>
            <input id="tiempo" class="admin-input" placeholder="7 min">
          </div>
          <div class="admin-field">
            <label class="admin-chip"><input id="destacado" type="checkbox"> Destacado</label>
          </div>
        </section>

        <section class="admin-card">
          <div class="admin-section-title">Imágenes</div>
          <div class="admin-field">
            <label for="imagen">Imagen<span class="admin-label-required">Obligatorio</span></label>
            <input id="imagen" class="admin-input" placeholder="/assets/images/blog/...">
            <span class="admin-field__message" id="imagen-message"></span>
          </div>
          <div class="admin-field">
            <label for="imagen_vertical">Imagen vertical (portrait)</label>
            <input id="imagen_vertical" class="admin-input" placeholder="assets/images/social/blog/ejemplo.png">
            <span class="admin-field__help">Debe ser un PNG dentro de assets/images/social/blog/</span>
            <span class="admin-field__message" id="imagen_vertical-message"></span>
          </div>
        </section>

        <section class="admin-card">
          <div class="admin-section-title">SEO</div>
          <div class="admin-field">
            <label for="fragmento">Fragmento<span class="admin-label-required">Obligatorio</span></label>
            <textarea id="fragmento" rows="4" class="admin-input" placeholder="Resumen breve del post"></textarea>
            <span class="admin-field__help">Ideal entre 120 y 240 caracteres.</span>
            <span class="admin-field__message" id="fragmento-message"></span>
          </div>
          <div class="admin-field">
            <label for="fragmento_social">Fragmento social</label>
            <textarea id="fragmento_social" rows="3" class="admin-input" placeholder="Texto corto para redes"></textarea>
            <div id="fragmento_social_counters">
              <small>280: <span id="fragmento_social_count_280">0/280</span></small><br>
              <small>300: <span id="fragmento_social_count_300">0/300</span></small>
            </div>
            <span class="admin-field__message" id="fragmento_social-message"></span>
          </div>
          <div class="admin-field">
            <label for="categoria_temas">Categoría Temas (coma)</label>
            <input id="categoria_temas" class="admin-input" placeholder="creación, espiritualidad">
          </div>
          <div class="admin-field">
            <label for="categoria_libros">Categoría Libros (coma)</label>
            <input id="categoria_libros" class="admin-input" placeholder="saga, mundo">
          </div>
          <div class="admin-field">
            <label for="topicos">Tópicos (coma)</label>
            <input id="topicos" class="admin-input" placeholder="misterio, inspiración">
          </div>
        </section>
      </aside>

      <section class="admin-column">
        <section class="admin-card">
          <div class="admin-section-title">Contenido</div>
          <div id="editor"></div>
          <div class="admin-actions" style="margin-top: 1.25rem;">
            <button id="previewBtn" class="admin-button admin-button--ghost">Vista previa</button>
            <button id="saveBtn" class="admin-button admin-button--secondary">Guardar</button>
            <button id="saveOpenBtn" class="admin-button admin-button--primary">Guardar y abrir</button>
          </div>
        </section>

        <section class="admin-card">
          <div class="admin-section-title">Vista previa</div>
          <div class="admin-preview" id="preview"></div>
        </section>
      </section>
    </main>
  </div>

  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    const quill = new Quill('#editor', { theme: 'snow' });

    const TOKEN_KEY = 'adminToken';

    const formElements = {
      id: document.getElementById('id'),
      titulo: document.getElementById('titulo'),
      slug: document.getElementById('slug'),
      autor: document.getElementById('autor'),
      fecha: document.getElementById('fecha'),
      categoria_temas: document.getElementById('categoria_temas'),
      categoria_libros: document.getElementById('categoria_libros'),
      topicos: document.getElementById('topicos'),
      tiempo: document.getElementById('tiempo'),
      fragmento: document.getElementById('fragmento'),
      fragmento_social: document.getElementById('fragmento_social'),
      imagen: document.getElementById('imagen'),
      imagen_vertical: document.getElementById('imagen_vertical'),
      destacado: document.getElementById('destacado')
    };

    const statusBanner = document.getElementById('statusBanner');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');
    const statusTimestamp = document.getElementById('statusTimestamp');
    const lastSaved = document.getElementById('lastSaved');
    const errorCount = document.getElementById('errorCount');
    const errorList = document.getElementById('errorList');

    function getToken() {
      let token = sessionStorage.getItem(TOKEN_KEY);
      if (!token) {
        token = prompt('Ingresa el token de administrador');
        if (token) sessionStorage.setItem(TOKEN_KEY, token.trim());
      }
      return token;
    }

    async function fetchWithAuth(url, options = {}) {
      const token = getToken();
      if (!token) throw new Error('No se proporcionó token de administrador');

      const opts = { ...options };
      const headers = new Headers(opts.headers || {});
      headers.set('x-admin-token', token);
      opts.headers = headers;

      const response = await fetch(url, opts);
      if (response.status === 401) {
        sessionStorage.removeItem(TOKEN_KEY);
        alert('Token inválido o falta autorización. Intenta nuevamente.');
        throw new Error('Unauthorized');
      }
      return response;
    }

    function normalizeSocialImagePath(value) {
      if (!value) return '';
      let normalized = value.trim();
      normalized = normalized.replace(/^https?:\/\/[^/]+/i, '');
      normalized = normalized.replace(/^\/+/, '');

      if (normalized.toLowerCase().startsWith('assets/images/social/')) {
        normalized = normalized.slice('assets/images/social/'.length);
      }

      normalized = normalized.replace(/^\/+/, '');
      if (!normalized) return '';

      if (!normalized.toLowerCase().startsWith('blog/')) {
        normalized = normalized.replace(/^blog\//i, '');
        normalized = normalized.replace(/^fortune_cookies\//i, '');
        normalized = normalized.replace(/^\/+/, '');
        normalized = `blog/${normalized}`;
      } else {
        normalized = `blog/${normalized.slice(5)}`;
      }

      return `assets/images/social/${normalized}`;
    }

    function slugify(value) {
      return value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
    }

    function escapeHtml(value) {
      return value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function setFieldState(fieldId, status, message) {
      const field = document.getElementById(fieldId);
      const messageEl = document.getElementById(`${fieldId}-message`);
      if (!field || !messageEl) return;

      field.classList.remove('admin-input--error', 'admin-input--ok');
      messageEl.classList.remove('admin-field__message--success');
      if (status === 'error') {
        field.classList.add('admin-input--error');
      } else if (status === 'ok') {
        field.classList.add('admin-input--ok');
        messageEl.classList.add('admin-field__message--success');
      }
      messageEl.textContent = message || '';
    }

    function updateStatusBanner(type, title, message) {
      statusBanner.classList.remove('admin-status--success', 'admin-status--error');
      if (type === 'success') statusBanner.classList.add('admin-status--success');
      if (type === 'error') statusBanner.classList.add('admin-status--error');
      statusTitle.textContent = title;
      statusMessage.textContent = message;
      statusTimestamp.textContent = type === 'success' ? `Actualizado: ${new Date().toLocaleString()}` : '';
    }

    function updateErrorPanel(errors) {
      errorCount.textContent = String(errors.length);
      errorList.innerHTML = '';
      errors.forEach(error => {
        const li = document.createElement('li');
        li.textContent = error;
        errorList.appendChild(li);
      });
    }

    function validateDate(value) {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(value)) return false;
      const [year, month, day] = value.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      return date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day;
    }

    function validateForm() {
      const errors = [];
      const titulo = formElements.titulo.value.trim();
      const slug = formElements.slug.value.trim();
      const fecha = formElements.fecha.value.trim();
      const fragmento = formElements.fragmento.value.trim();
      const fragmentoSocial = formElements.fragmento_social.value.trim();
      const imagen = formElements.imagen.value.trim();
      const imagenVertical = formElements.imagen_vertical.value.trim();

      if (!titulo) {
        setFieldState('titulo', 'error', 'El título es obligatorio.');
        errors.push('Falta el título del post.');
      } else {
        setFieldState('titulo', 'ok', 'Título listo.');
      }

      if (!slug) {
        setFieldState('slug', 'error', 'El slug no puede estar vacío.');
        errors.push('El slug está vacío.');
      } else {
        setFieldState('slug', 'ok', 'Slug listo.');
      }

      if (!fecha) {
        setFieldState('fecha', 'error', 'Ingresa una fecha de publicación.');
        errors.push('Falta la fecha de publicación.');
      } else if (!validateDate(fecha)) {
        setFieldState('fecha', 'error', 'Formato inválido. Usa YYYY-MM-DD.');
        errors.push('La fecha ingresada no es válida.');
      } else {
        setFieldState('fecha', 'ok', 'Fecha válida.');
      }

      if (!fragmento) {
        setFieldState('fragmento', 'error', 'El fragmento es obligatorio.');
        errors.push('Falta el fragmento del post.');
      } else if (fragmento.length < 120 || fragmento.length > 240) {
        setFieldState('fragmento', 'error', 'Debe tener entre 120 y 240 caracteres.');
        errors.push('El fragmento no cumple con la longitud recomendada.');
      } else {
        setFieldState('fragmento', 'ok', 'Fragmento listo.');
      }

      if (fragmentoSocial.length > 300) {
        setFieldState('fragmento_social', 'error', 'El fragmento social supera 300 caracteres.');
        errors.push('El fragmento social excede el máximo permitido.');
      } else {
        setFieldState('fragmento_social', fragmentoSocial ? 'ok' : '', fragmentoSocial ? '' : '');
      }

      if (!imagen) {
        setFieldState('imagen', 'error', 'La imagen principal es obligatoria.');
        errors.push('Falta la imagen principal.');
      } else {
        setFieldState('imagen', 'ok', 'Imagen principal lista.');
      }

      if (imagenVertical) {
        const normalized = normalizeSocialImagePath(imagenVertical);
        if (!normalized.toLowerCase().endsWith('.png') || !normalized.toLowerCase().startsWith('assets/images/social/blog/')) {
          setFieldState('imagen_vertical', 'error', 'Debe ser un PNG dentro de assets/images/social/blog/.');
          errors.push('La imagen vertical no cumple con el formato requerido.');
        } else {
          setFieldState('imagen_vertical', 'ok', '');
        }
      } else {
        setFieldState('imagen_vertical', '', '');
      }

      updateErrorPanel(errors);
      return errors;
    }

    function buildPreview() {
      const titulo = formElements.titulo.value.trim() || 'Título del post';
      const autor = formElements.autor.value.trim() || 'Lauren Cuervo';
      const fecha = formElements.fecha.value.trim() || 'Fecha de publicación';
      const fragmento = formElements.fragmento.value.trim() || 'Comparte en pocas líneas la esencia del post.';
      const imagen = formElements.imagen.value.trim();
      const contenido = quill.root.innerHTML.trim() || '<p>Empieza a escribir el contenido para ver la vista previa.</p>';
      const signature = `— ${autor}`;
      const placeholderImage = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

      return `
        <article class="blog-entry">
          <h1 class="blog-entry__title">${escapeHtml(titulo)}</h1>
          <span class="blog-entry__date">${escapeHtml(fecha)}</span>
          <p class="blog-entry__snippet">${escapeHtml(fragmento)}</p>
          <div class="blog-entry__content">
            <figure>
              <img loading="lazy" src="${escapeHtml(imagen || placeholderImage)}" alt="${escapeHtml(titulo)}" class="blog-entry__image" />
              <figcaption></figcaption>
            </figure>
            ${contenido}
          </div>
          <p class="blog-entry__signature">${escapeHtml(signature)}</p>
        </article>
      `;
    }

    function updatePreview() {
      document.getElementById('preview').innerHTML = buildPreview();
    }

    function updateFragmentoSocialCounters() {
      const len = formElements.fragmento_social.value.length;
      const fragmentoSocialCounter280 = document.getElementById('fragmento_social_count_280');
      const fragmentoSocialCounter300 = document.getElementById('fragmento_social_count_300');

      if (fragmentoSocialCounter280) {
        fragmentoSocialCounter280.textContent = `${len}/280`;
        fragmentoSocialCounter280.style.color = len > 280 ? '#f0ad4e' : '';
      }
      if (fragmentoSocialCounter300) {
        fragmentoSocialCounter300.textContent = `${len}/300`;
        fragmentoSocialCounter300.style.color = len > 300 ? '#d9534f' : '';
      }
    }

    function updateSlugFromTitle() {
      if (formElements.slug.dataset.manual === 'true') {
        return;
      }
      formElements.slug.value = slugify(formElements.titulo.value);
    }

    // Carga posts existentes
    let posts = [];
    async function loadPosts() {
      try {
        posts = await fetchWithAuth('/posts', { credentials: 'include' }).then(r => r.json());
      } catch (err) {
        console.error(err);
        return;
      }
      const select = document.getElementById('postSelect');
      posts.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.id} – ${p.titulo}`;
        select.appendChild(opt);
      });
      select.onchange = () => {
        const p = posts.find(x => x.id == select.value);
        if (p) fillForm(p); else clearForm();
      };
    }

    function fillForm(p) {
      formElements.id.value = p.id;
      formElements.titulo.value = p.titulo;
      formElements.autor.value = p.autor;
      formElements.fecha.value = p.fecha;
      formElements.categoria_temas.value = p.categoria_temas.join(', ');
      formElements.categoria_libros.value = p.categoria_libros.join(', ');
      formElements.topicos.value = p.topicos.join(', ');
      formElements.tiempo.value = p.tiempo;
      formElements.fragmento.value = p.fragmento;
      formElements.fragmento_social.value = p.fragmento_social || '';
      formElements.imagen.value = p.imagen;
      formElements.imagen_vertical.value = normalizeSocialImagePath(p.imagen_vertical || '');
      formElements.slug.value = p.slug;
      formElements.slug.dataset.manual = 'true';
      formElements.destacado.checked = p.destacado;
      quill.root.innerHTML = p.contenido_html;
      updateFragmentoSocialCounters();
      updatePreview();
      validateForm();
    }

    function clearForm() {
      document.querySelectorAll('input.admin-input, textarea.admin-input').forEach(e => {
        e.value = '';
      });
      formElements.destacado.checked = false;
      formElements.slug.dataset.manual = 'false';
      quill.root.innerHTML = '';
      updateFragmentoSocialCounters();
      updatePreview();
      validateForm();
    }

    document.getElementById('previewBtn').onclick = () => {
      updatePreview();
      document.getElementById('preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    const fragmentoSocial = document.getElementById('fragmento_social');

    updateFragmentoSocialCounters();
    updatePreview();

    formElements.titulo.addEventListener('input', () => {
      updateSlugFromTitle();
      updatePreview();
      validateForm();
    });

    formElements.slug.addEventListener('input', () => {
      formElements.slug.dataset.manual = formElements.slug.value.trim() ? 'true' : 'false';
      updatePreview();
      validateForm();
    });

    formElements.fecha.addEventListener('input', () => {
      updatePreview();
      validateForm();
    });

    formElements.fragmento.addEventListener('input', () => {
      updatePreview();
      validateForm();
    });

    fragmentoSocial.addEventListener('input', () => {
      updateFragmentoSocialCounters();
      updatePreview();
      validateForm();
    });

    formElements.autor.addEventListener('input', () => {
      updatePreview();
    });

    formElements.imagen.addEventListener('input', () => {
      updatePreview();
      validateForm();
    });

    formElements.imagen_vertical.addEventListener('input', () => {
      validateForm();
    });

    quill.on('text-change', () => {
      updatePreview();
    });

    document.getElementById('saveBtn').onclick = async () => {
      if (!formElements.slug.value.trim()) {
        updateSlugFromTitle();
      }
      const errors = validateForm();
      if (errors.length) {
        updateStatusBanner('error', 'Revisa los campos', 'Hay errores de validación que debes corregir.');
        return;
      }

      const imagenVerticalInput = normalizeSocialImagePath(formElements.imagen_vertical.value);

      const post = {
        id: Number(formElements.id.value || Date.now()),
        titulo: formElements.titulo.value,
        autor: formElements.autor.value,
        fecha: formElements.fecha.value,
        categoria_temas: formElements.categoria_temas.value.split(',').map(s => s.trim()).filter(Boolean),
        categoria_libros: formElements.categoria_libros.value.split(',').map(s => s.trim()).filter(Boolean),
        topicos: formElements.topicos.value.split(',').map(s => s.trim()).filter(Boolean),
        tiempo: formElements.tiempo.value,
        fragmento: formElements.fragmento.value,
        fragmento_social: fragmentoSocial.value,
        imagen: formElements.imagen.value,
        imagen_vertical: imagenVerticalInput,
        slug: formElements.slug.value || slugify(formElements.titulo.value),
        contenido_html: quill.root.innerHTML,
        destacado: formElements.destacado.checked
      };

      try {
        await fetchWithAuth('/save-post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(post),
          credentials: 'include'
        });
        const timestamp = new Date().toLocaleString();
        lastSaved.textContent = timestamp;
        updateStatusBanner('success', 'Post guardado exitosamente', 'Tu entrada ya está lista para compartir.');
      } catch (err) {
        console.error(err);
        updateStatusBanner('error', 'No se pudo guardar', 'Hubo un problema al guardar el post.');
      }
    };

    document.getElementById('saveOpenBtn').onclick = async () => {
      await document.getElementById('saveBtn').onclick();
      if (errorCount.textContent === '0') {
        const slug = formElements.slug.value.trim();
        if (slug) {
          window.open(`/blog/${encodeURIComponent(slug)}.html`, '_blank');
        }
      }
    };

    loadPosts();
  </script>
</body>
</html>
