<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Blog</title>

  <!-- estilos del sitio para la vista previa -->
  <link rel="stylesheet" href="/css/styles.889d2a038d.css">

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    #editor { height: 300px; }
    .preview { border:1px solid #ccc; padding:1rem; margin-top:1rem; }
  </style>
</head>
<body>
  <h1>Nuevo/Editar Post</h1>

  <label>Seleccionar post:
    <select id="postSelect">
      <option value="">— Nuevo —</option>
    </select>
  </label><br><br>

  <label>ID:<br><input id="id" type="number"></label><br><br>
  <label>Título:<br><input id="titulo"></label><br><br>
  <label>Autor:<br><input id="autor"></label><br><br>
  <label>Fecha (YYYY-MM-DD):<br><input id="fecha"></label><br><br>
  <label>Categoría Temas (coma):<br><input id="categoria_temas"></label><br><br>
  <label>Categoría Libros (coma):<br><input id="categoria_libros"></label><br><br>
  <label>Tópicos (coma):<br><input id="topicos"></label><br><br>
  <label>Tiempo de lectura:<br><input id="tiempo"></label><br><br>
  <label>Fragmento:<br><textarea id="fragmento"></textarea></label><br><br>
  <label>Fragmento Social:<br><textarea id="fragmento_social"></textarea></label>
  <div id="fragmento_social_counters" style="margin-top:0.5rem; margin-bottom:1rem;">
    <small style="display:block;">280: <span id="fragmento_social_count_280">0/280</span></small>
    <small style="display:block;">300: <span id="fragmento_social_count_300">0/300</span></small>
    <div id="fragmento_social_warning" style="color:#d9534f; font-weight:bold; display:none; margin-top:0.25rem;"></div>
  </div>
  <label>Imagen:<br><input id="imagen"></label><br><br>
  <label>Slug:<br><input id="slug"></label><br><br>
  <label>Destacado:<input id="destacado" type="checkbox"></label><br><br>

  <div id="editor"></div>
  <button id="previewBtn">Vista previa</button>
  <button id="saveBtn">Guardar</button>

  <div class="preview" id="preview"></div>

  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    const quill = new Quill('#editor', { theme: 'snow' });

    const TOKEN_KEY = 'adminToken';

    function getToken() {
      let token = sessionStorage.getItem(TOKEN_KEY);
      if (!token) {
        token = prompt('Ingresa el token de administrador');
        if (token) sessionStorage.setItem(TOKEN_KEY, token.trim());
      }
      return token;
    }

    async function fetchWithAuth(url, options = {}) {
      const token = getToken();
      if (!token) throw new Error('No se proporcionó token de administrador');

      const opts = { ...options };
      const headers = new Headers(opts.headers || {});
      headers.set('x-admin-token', token);
      opts.headers = headers;

      const response = await fetch(url, opts);
      if (response.status === 401) {
        sessionStorage.removeItem(TOKEN_KEY);
        alert('Token inválido o falta autorización. Intenta nuevamente.');
        throw new Error('Unauthorized');
      }
      return response;
    }

    // Carga posts existentes
    let posts = [];
    async function loadPosts() {
      try {
        posts = await fetchWithAuth('/posts', { credentials: 'include' }).then(r => r.json());
      } catch (err) {
        console.error(err);
        return;
      }
      const select = document.getElementById('postSelect');
      posts.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.id} – ${p.titulo}`;
        select.appendChild(opt);
      });
      select.onchange = () => {
        const p = posts.find(x => x.id == select.value);
        if (p) fillForm(p); else clearForm();
      };
    }

    function fillForm(p) {
      document.getElementById('id').value     = p.id;
      document.getElementById('titulo').value = p.titulo;
      document.getElementById('autor').value  = p.autor;
      document.getElementById('fecha').value  = p.fecha;
      document.getElementById('categoria_temas').value  = p.categoria_temas.join(', ');
      document.getElementById('categoria_libros').value = p.categoria_libros.join(', ');
      document.getElementById('topicos').value          = p.topicos.join(', ');
      document.getElementById('tiempo').value    = p.tiempo;
      document.getElementById('fragmento').value = p.fragmento;
      document.getElementById('fragmento_social').value = p.fragmento_social || '';
      document.getElementById('imagen').value    = p.imagen;
      document.getElementById('slug').value      = p.slug;
      document.getElementById('destacado').checked = p.destacado;
      quill.root.innerHTML = p.contenido_html;
      updateFragmentoSocialCounters();
    }

    function clearForm() {
      document.querySelectorAll('input, textarea').forEach(e => {
        if (e.type === 'checkbox') e.checked = false;
        else e.value = '';
      });
      quill.root.innerHTML = '';
      updateFragmentoSocialCounters();
    }

    document.getElementById('previewBtn').onclick =
      () => document.getElementById('preview').innerHTML = quill.root.innerHTML;

    const fragmentoSocial = document.getElementById('fragmento_social');
    const fragmentoSocialCounter280 = document.getElementById('fragmento_social_count_280');
    const fragmentoSocialCounter300 = document.getElementById('fragmento_social_count_300');
    const fragmentoSocialWarning = document.getElementById('fragmento_social_warning');

    function updateFragmentoSocialCounters() {
      const len = fragmentoSocial.value.length;
      if (fragmentoSocialCounter280) {
        fragmentoSocialCounter280.textContent = `${len}/280`;
        fragmentoSocialCounter280.style.color = len > 280 ? '#f0ad4e' : '';
      }
      if (fragmentoSocialCounter300) {
        fragmentoSocialCounter300.textContent = `${len}/300`;
        fragmentoSocialCounter300.style.color = len > 300 ? '#d9534f' : '';
      }

      if (len > 300) {
        fragmentoSocialWarning.textContent = 'Has superado el límite de 300 caracteres.';
        fragmentoSocialWarning.style.display = 'block';
        fragmentoSocial.style.borderColor = '#d9534f';
      } else if (len > 280) {
        fragmentoSocialWarning.textContent = 'Has superado el límite recomendado de 280 caracteres.';
        fragmentoSocialWarning.style.display = 'block';
        fragmentoSocial.style.borderColor = '#f0ad4e';
      } else {
        fragmentoSocialWarning.textContent = '';
        fragmentoSocialWarning.style.display = 'none';
        fragmentoSocial.style.borderColor = '';
      }
    }

    fragmentoSocial.addEventListener('input', updateFragmentoSocialCounters);
    fragmentoSocial.addEventListener('keyup', updateFragmentoSocialCounters);

    updateFragmentoSocialCounters();

    document.getElementById('saveBtn').onclick = async () => {
      const post = {
        id: Number(document.getElementById('id').value || Date.now()),
        titulo: document.getElementById('titulo').value,
        autor:  document.getElementById('autor').value,
        fecha:  document.getElementById('fecha').value,
        categoria_temas:  document.getElementById('categoria_temas').value.split(',').map(s => s.trim()).filter(Boolean),
        categoria_libros: document.getElementById('categoria_libros').value.split(',').map(s => s.trim()).filter(Boolean),
        topicos:          document.getElementById('topicos').value.split(',').map(s => s.trim()).filter(Boolean),
        tiempo:    document.getElementById('tiempo').value,
        fragmento: document.getElementById('fragmento').value,
        fragmento_social: fragmentoSocial.value,
        imagen:    document.getElementById('imagen').value,
        slug:      document.getElementById('slug').value || document.getElementById('titulo').value.toLowerCase().replace(/\s+/g, '-'),
        contenido_html: quill.root.innerHTML,
        destacado: document.getElementById('destacado').checked
      };

      try {
        await fetchWithAuth('/save-post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(post),
          credentials: 'include'
        });
        alert('Post guardado');
      } catch (err) {
        console.error(err);
      }
    };

    loadPosts();
  </script>
</body>
</html>
