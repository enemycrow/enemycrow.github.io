<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fortune Cookie â€“ Plumafarollama / Marsheeall, Sharkody &amp; Co.</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="fortune.css">
</head>
<body>
  <main class="fortune-app">
    <div class="cookie-stage" aria-live="polite">
      <button id="cookieButton" class="cookie-button" aria-expanded="false" aria-controls="fortune-panel">
        <span class="sr-only">Abrir galleta de la fortuna</span>
  <!-- Usar rutas absolutas y cache-bust para evitar cargar una versiÃ³n en cachÃ© equivocada -->
  <img src="/fortune_cookie/assets/cookie-closed.svg?v=3" alt="Galleta cerrada" class="cookie cookie--closed">
  <img src="/fortune_cookie/assets/cookie-open.svg?v=3" alt="Galleta abierta" class="cookie cookie--open" aria-hidden="true">
      </button>
    </div>

    <section id="fortune-panel" class="fortune-panel" aria-hidden="true">
      <div class="fortune-paper" role="presentation">
        <img src="assets/paper.svg" alt="" aria-hidden="true" class="paper-art">
        <div class="fortune-text">
          <blockquote id="fortuneMessage" class="fortune-message">
            <p></p>
            <cite id="fortuneAuthor"></cite>
          </blockquote>
        </div>
      </div>

      <div class="fortune-details">
        <div class="fortune-author" id="fortuneAvatar" aria-label="Autor"></div>
        <div class="fortune-image" id="fortuneImageWrapper">
          <img id="fortuneImage" alt="IlustraciÃ³n de la fortuna" loading="lazy">
          <p class="fortune-stamp">Marsheeall, Sharkody & Co.</p>
        </div>
        <div class="fortune-tags" id="fortuneTags" aria-label="Etiquetas"></div>
        <time id="fortuneDate" class="fortune-date" datetime=""></time>
      </div>

      <div class="fortune-actions">
        <button id="anotherFortune" class="pill-button" type="button">âœ¨ Otra fortuna</button>
        <button id="shareFortune" class="pill-button pill-button--secondary" type="button">ðŸ”— Compartir</button>
      </div>
    </section>

    <section class="fortune-error" id="fortuneError" hidden>
      <p>Ups, no pudimos cargar las galletitas ahora mismo. Â¿Intentamos de nuevo?</p>
      <button id="retryLoad" class="pill-button" type="button">Reintentar</button>
    </section>
  </main>

  <template id="tagTemplate">
    <span class="fortune-chip"></span>
  </template>

  <script src="fortune.js" type="module"></script>
  <!-- Dev helper: si estamos en localhost, desregistrar service workers y limpiar caches para evitar servir assets obsoletos -->
  <script>
    (function() {
      try {
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => {
              regs.forEach(r => r.unregister());
            });
          }
          if (window.caches && caches.keys) {
            caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
          }
          console.info('Dev: Service workers unregistered and caches cleared (localhost).');
        }
      } catch (e) {
        console.warn('Dev: no se pudo limpiar SW/caches', e);
      }
    })();
  </script>
  <!-- SW logs client: solicitar logs al service worker y mostrarlos -->
  <script>
    (function() {
      if (!('serviceWorker' in navigator)) return;
      function requestSWLogs(limit = 200) {
        if (!navigator.serviceWorker.controller) {
          console.info('No SW controlling this page');
          return;
        }
        const messageChannel = new MessageChannel();
        messageChannel.port1.onmessage = ev => {
          const data = ev.data || {};
          if (data.type === 'sw-logs') {
            console.group('SW logs');
            (data.logs || []).forEach(l => console.log(new Date(l.ts).toISOString(), l.msg));
            console.groupEnd();
            // Optionally render into DOM if #sw-logs exists
            const container = document.getElementById('sw-logs');
            if (container) {
              container.innerHTML = '';
              (data.logs || []).forEach(l => {
                const el = document.createElement('div');
                el.textContent = new Date(l.ts).toLocaleString() + ' â€” ' + l.msg;
                container.appendChild(el);
              });
            }
          }
        };
        navigator.serviceWorker.controller.postMessage({ type: 'get-sw-logs', limit }, [messageChannel.port2]);
      }

      // Auto-request logs in dev/localhost to help debugging
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        navigator.serviceWorker.ready.then(() => setTimeout(() => requestSWLogs(200), 500));
      }

      // Expose helper for manual use from console
      window.requestSWLogs = requestSWLogs;
    })();
  </script>
</body>
</html>
