<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rompecabezas ‚Äî La Pluma, el Faro y la Llama</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --accent:#6b21a8;
    --muted:#6b7280;
    --size:480px;
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{margin:0;background:linear-gradient(180deg,#fbfbff,var(--bg));color:#111;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:28px;}
  .app{width:100%;max-width:1100px;}
  header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#fef3c7,#fed7aa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#7c3aed}
  h1{font-size:20px;margin:0}
  .layout{display:grid;grid-template-columns:1fr 320px;gap:18px}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
  /* board */
  .board-wrap{display:flex;flex-direction:column;gap:12px;align-items:center}
  .board{width:var(--size);height:var(--size);position:relative;border-radius:10px;overflow:hidden;background:#ddd;touch-action:manipulation}
  .tile{position:absolute;box-shadow:inset 0 -2px 0 rgba(0,0,0,0.06);border-radius:6px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:600}
  .tile.blank{background:transparent;cursor:default}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;background:var(--accent);color:#fff;font-weight:600}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(107,33,168,0.12)}
  .small{font-size:13px;padding:6px 8px}
  .meta{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:14px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], select, input[type="file"]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6f0;background:#fff}
  .help{font-size:12px;color:#7b7b88}
  .win{padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,#ecfccb,#bbf7d0);color:#064e3b;font-weight:700;display:inline-block}
  footer{margin-top:14px;text-align:center;color:#8b8b96;font-size:12px}
  @media (max-width:980px){ .layout{grid-template-columns:1fr} :root{--size:360px} .board{width:var(--size);height:var(--size)} }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">‚ô£Ô∏è</div>
      <div>
        <h1>Rompecabezas ‚Äî La Pluma, el Faro y la Llama</h1>
        <div class="help">Sube una imagen o pega una URL, elige dificultad y juega. üíú</div>
      </div>
    </header>

    <div class="layout">
      <div class="card">
        <div class="board-wrap">
          <div style="display:flex;gap:10px;align-items:center;width:100%;justify-content:space-between;margin-bottom:4px">
            <div class="meta">
              <div>Tiempo: <strong id="time">00:00</strong></div>
              <div>Movimientos: <strong id="moves">0</strong></div>
            </div>
            <div id="status" class=""></div>
          </div>

          <div id="board" class="board" aria-label="Tablero del rompecabezas"></div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button id="shuffleBtn" class="btn small">Mezclar</button>
            <button id="resetBtn" class="btn ghost small">Colocar orden</button>
            <select id="sizeSelect" style="width:120px;padding:8px;border-radius:8px;border:1px solid #e6e6f0">
              <option value="3">3 √ó 3 (f√°cil)</option>
              <option value="4" selected>4 √ó 4 (medio)</option>
              <option value="5">5 √ó 5 (dif√≠cil)</option>
              <option value="6">6 √ó 6 (experto)</option>
            </select>
            <button id="solvePreview" class="btn ghost small" title="Puesta en orden visual (sin resolverlo paso a paso)">Mostrar soluci√≥n</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;flex-direction:column;gap:12px">
          <div>
            <label for="imgUrl">Pegar URL de imagen</label>
            <input id="imgUrl" type="text" placeholder="https://...jpg (recomiendo cuadrada)">
          </div>

          <div>
            <label for="imgFile">O subir imagen</label>
            <input id="imgFile" type="file" accept="image/*">
            <div class="help">Sugerencia: usa im√°genes cuadradas o personajes centrados.</div>
          </div>

          <div>
            <label>Opciones</label>
            <div style="display:flex;gap:8px">
              <button id="useDefault" class="btn small">Imagen por defecto</button>
              <button id="shareBtn" class="btn ghost small" title="Copia URL con tama√±o y estado (local)">Compartir/Guardar</button>
            </div>
          </div>

          <div>
            <label>Records (local)</label>
            <div id="records" class="help">A√∫n no hay records.</div>
          </div>

          <div style="border-top:1px dashed #eee;padding-top:8px">
            <div class="help">Caracter√≠sticas: mezcla siempre resoluble, compatible mobile (tap) y escritorio (click).</div>
          </div>
        </div>
      </div>
    </div>

    <footer class="help">Hecho con ‚ù§ para Corbeau ‚Äî Nova Estelle Carmin√©</footer>
  </div>

<script>
/* Rompecabezas deslizante en un archivo.
   Caracter√≠sticas: tama√±o din√°mico, mezcla resoluble, imagen por URL o archivo, contador tiempo/movimientos, aviso al ganar.
*/

/* ---------- Helper utils ---------- */
function range(n){ return Array.from({length:n},(_,i)=>i); }

function isSolvable(tiles, size){
  const arr = tiles.filter(v=>v!==null);
  let inv=0;
  for(let i=0;i<arr.length;i++){
    for(let j=i+1;j<arr.length;j++){
      if(arr[i] > arr[j]) inv++;
    }
  }
  if(size % 2 === 1) return inv % 2 === 0;
  const blankIndex = tiles.indexOf(null);
  const blankRowFromBottom = size - Math.floor(blankIndex / size);
  return (blankRowFromBottom % 2 === 0) ? (inv % 2 === 1) : (inv % 2 === 0);
}

function shuffleSolvable(size){
  const total = size*size;
  let tiles = range(total-1).concat([null]);
  do {
    // Fisher-Yates
    for(let i=tiles.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [tiles[i],tiles[j]]=[tiles[j],tiles[i]];
    }
  } while(!isSolvable(tiles,size) || isSolved(tiles));
  return tiles;
}

function isSolved(tiles){
  for(let i=0;i<tiles.length;i++){
    const last = tiles.length-1;
    if(i===last && tiles[i]===null) continue;
    if(tiles[i] !== i) return false;
  }
  return true;
}

/* ---------- DOM references ---------- */
const boardEl = document.getElementById('board');
const timeEl = document.getElementById('time');
const movesEl = document.getElementById('moves');
const statusEl = document.getElementById('status');
const sizeSelect = document.getElementById('sizeSelect');
const shuffleBtn = document.getElementById('shuffleBtn');
const resetBtn = document.getElementById('resetBtn');
const imgUrlInput = document.getElementById('imgUrl');
const imgFileInput = document.getElementById('imgFile');
const useDefaultBtn = document.getElementById('useDefault');
const recordsEl = document.getElementById('records');
const shareBtn = document.getElementById('shareBtn');
const solvePreviewBtn = document.getElementById('solvePreview');

/* ---------- State ---------- */
let size = parseInt(sizeSelect.value,10);
let tiles = [];
let moves = 0;
let timer = null;
let seconds = 0;
let running = false;
let boardPixelSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--size')) || 480;
let imgSrc = 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=1200&q=80&auto=format&fit=crop';

/* ---------- Timer ---------- */
function startTimer(){
  if(running) return;
  running = true;
  timer = setInterval(()=> {
    seconds++;
    updateTime();
  },1000);
}
function stopTimer(){
  running = false;
  if(timer) clearInterval(timer);
  timer = null;
}
function resetTimer(){
  stopTimer();
  seconds = 0;
  updateTime();
}
function updateTime(){
  const mm = String(Math.floor(seconds/60)).padStart(2,'0');
  const ss = String(seconds%60).padStart(2,'0');
  timeEl.textContent = mm + ":" + ss;
}

/* ---------- Board rendering ---------- */
function calcTileDimensions(){
  // responsive: board width equals CSS var --size or computed width
  const style = getComputedStyle(boardEl);
  const w = boardEl.clientWidth;
  return Math.floor(w / size);
}

function renderBoard(){
  boardEl.innerHTML = '';
  const tilePx = calcTileDimensions();
  boardEl.style.height = boardEl.style.width = (tilePx * size) + 'px';
  const total = size * size;
  // background sizing uses the total board pixel dimension
  const bgW = tilePx * size;
  tiles.forEach((val,i) => {
    const r = Math.floor(i / size);
    const c = i % size;
    const left = c * tilePx;
    const top = r * tilePx;
    const el = document.createElement('button');
    el.className = 'tile';
    el.style.width = tilePx + 'px';
    el.style.height = tilePx + 'px';
    el.style.left = left + 'px';
    el.style.top = top + 'px';
    el.setAttribute('data-index', i);
    if(val === null){
      el.classList.add('blank');
      el.innerHTML = '';
    } else {
      // background-position so piece shows correct fragment
      const pieceRow = Math.floor(val / size);
      const pieceCol = val % size;
      el.style.backgroundImage = `url("${imgSrc}")`;
      el.style.backgroundSize = `${bgW}px ${bgW}px`;
      const posX = - pieceCol * tilePx;
      const posY = - pieceRow * tilePx;
      el.style.backgroundPosition = `${posX}px ${posY}px`;
      el.style.border = '1px solid rgba(255,255,255,0.06)';
      el.title = 'Pieza ' + (val + 1);
      // optional label for debugging: el.textContent = (val+1);
    }
    el.addEventListener('click', onTileClick);
    boardEl.appendChild(el);
  });
}

function onTileClick(e){
  const idx = parseInt(e.currentTarget.getAttribute('data-index'),10);
  if(tiles[idx] === null) return;
  const blank = tiles.indexOf(null);
  const r = Math.floor(idx/size), c = idx % size;
  const br = Math.floor(blank/size), bc = blank % size;
  const isNeighbor = (r === br && Math.abs(c - bc) === 1) || (c === bc && Math.abs(r - br) === 1);
  if(!isNeighbor) return;
  // swap
  [tiles[idx], tiles[blank]] = [tiles[blank], tiles[idx]];
  moves++;
  movesEl.textContent = moves;
  if(!running) startTimer();
  renderBoard();
  if(isSolved(tiles)){
    stopTimer();
    statusEl.innerHTML = '<span class="win">¬°Resuelto! üéâ</span>';
    trySaveRecord();
  } else {
    statusEl.innerHTML = '';
  }
}

/* ---------- Controls ---------- */
function resetToOrdered(){
  tiles = range(size*size - 1).concat([null]);
  moves = 0;
  movesEl.textContent = moves;
  resetTimer();
  statusEl.innerHTML = '';
  renderBoard();
}

function shuffleAndStart(){
  tiles = shuffleSolvable(size);
  moves = 0;
  movesEl.textContent = moves;
  resetTimer();
  startTimer();
  statusEl.innerHTML = '';
  renderBoard();
}

sizeSelect.addEventListener('change', ()=>{
  size = parseInt(sizeSelect.value,10);
  resetToOrdered();
});

shuffleBtn.addEventListener('click', ()=> shuffleAndStart());
resetBtn.addEventListener('click', ()=> resetToOrdered());

imgUrlInput.addEventListener('change', ()=>{
  const v = imgUrlInput.value.trim();
  if(!v) return;
  loadImage(v, (ok) => {
    if(ok){
      imgSrc = v;
      renderBoard();
    } else alert('No se pudo cargar la imagen. Verifica la URL.');
  });
});

imgFileInput.addEventListener('change', (ev)=>{
  const file = ev.target.files?.[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  imgSrc = url;
  // slight delay to ensure it's usable as background
  setTimeout(()=> renderBoard(), 60);
});

useDefaultBtn.addEventListener('click', ()=> {
  imgSrc = 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=1200&q=80&auto=format&fit=crop';
  imgUrlInput.value = imgSrc;
  renderBoard();
});

shareBtn.addEventListener('click', ()=>{
  // simple state string (size + moves + seconds + encoded tiles)
  const payload = {
    size, moves, seconds, tiles
  };
  const s = encodeURIComponent(btoa(JSON.stringify(payload)));
  const shareUrl = location.href.split('#')[0] + '#p=' + s;
  navigator.clipboard?.writeText(shareUrl).then(()=> {
    alert('URL copiada al portapapeles. Puedes pegarla para compartir o guardar.');
  }).catch(()=> {
    prompt('Copia esta URL:', shareUrl);
  });
});

solvePreviewBtn.addEventListener('click', ()=>{
  // show ordered board for 1.8s as preview (no solving steps)
  const prev = tiles.slice();
  tiles = range(size*size - 1).concat([null]);
  renderBoard();
  setTimeout(()=> {
    tiles = prev;
    renderBoard();
  },1800);
});

/* ---------- Persistence records (localStorage) ---------- */
function tryLoadRecords(){
  const k = localStorage.getItem('puzzle_records');
  if(!k) return [];
  try { return JSON.parse(k) } catch(e){ return []; }
}
function trySaveRecord(){
  if(!isSolved(tiles)) return;
  const rec = tryLoadRecords();
  const entry = {size, moves, time: seconds, when: new Date().toISOString()};
  rec.push(entry);
  // keep best per size by time (asc)
  const best = rec.filter(r=>r.size===size).sort((a,b)=> (a.time - b.time))[0];
  localStorage.setItem('puzzle_records', JSON.stringify(rec));
  updateRecordsUI();
  // friendly alert
  setTimeout(()=> alert(`¬°Felicidades! Rompecabezas resuelto en ${moves} movimientos ‚Äî ${timeEl.textContent}`), 120);
}
function updateRecordsUI(){
  const rec = tryLoadRecords();
  if(rec.length===0){ recordsEl.textContent = 'A√∫n no hay records.'; return; }
  // show best per size
  const grouped = {};
  rec.forEach(r => {
    if(!grouped[r.size]) grouped[r.size]=[];
    grouped[r.size].push(r);
  });
  let html = '';
  for(const s in grouped){
    const best = grouped[s].sort((a,b)=> a.time - b.time)[0];
    html += `Mejor (${s}√ó${s}): ${formatSec(best.time)} ‚Äî ${best.moves} mov ‚Äî ${new Date(best.when).toLocaleDateString()}<br>`;
  }
  recordsEl.innerHTML = html;
}
function formatSec(sec){
  const mm = String(Math.floor(sec/60)).padStart(2,'0');
  const ss = String(sec%60).padStart(2,'0');
  return mm + ':' + ss;
}

/* ---------- Image loader check ---------- */
function loadImage(url, cb){
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = ()=> cb(true);
  img.onerror = ()=> cb(false);
  img.src = url;
}

/* ---------- Resize handling ---------- */
let resizeTimer;
window.addEventListener('resize', ()=> {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=> renderBoard(), 120);
});

/* ---------- Init ---------- */
function init(){
  size = parseInt(sizeSelect.value,10);
  imgSrc = imgUrlInput.value.trim() || imgSrc;
  resetToOrdered();
  updateRecordsUI();
  // if hash with state present, try restore
  if(location.hash.startsWith('#p=')){
    try{
      const payload = JSON.parse(atob(decodeURIComponent(location.hash.slice(3))));
      if(payload && payload.size){
        sizeSelect.value = String(payload.size);
        size = payload.size;
        tiles = payload.tiles;
        moves = payload.moves || 0;
        seconds = payload.seconds || 0;
        movesEl.textContent = moves;
        updateTime();
        renderBoard();
      }
    }catch(e){}
  }
}

init();

/* ---------- accessibility: keyboard arrows to move blank ---------- */
document.addEventListener('keydown',(e)=>{
  if(!['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) return;
  const blank = tiles.indexOf(null);
  const br = Math.floor(blank/size), bc = blank % size;
  let target = null;
  if(e.key === 'ArrowUp'){ // move tile down into blank (blank up => swap with below tile)
    const rr = br + 1;
    if(rr < size) target = rr * size + bc;
  } else if(e.key === 'ArrowDown'){
    const rr = br - 1;
    if(rr >= 0) target = rr * size + bc;
  } else if(e.key === 'ArrowLeft'){
    const cc = bc + 1;
    if(cc < size) target = br * size + cc;
  } else if(e.key === 'ArrowRight'){
    const cc = bc - 1;
    if(cc >= 0) target = br * size + cc;
  }
  if(target !== null){
    // simulate click on tile index target
    const node = boardEl.querySelector(`[data-index="${target}"]`);
    if(node) node.click();
  }
});
</script>
</body>
</html>
